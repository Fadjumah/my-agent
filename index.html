<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>My AI Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Geist+Mono:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --ink: #0d0d0f;
  --paper: #f5f2eb;
  --paper2: #ede9df;
  --paper3: #e4dfd3;
  --accent: #c8410a;
  --accent2: #1a6b3a;
  --accent3: #1a3a6b;
  --muted: #8a8578;
  --border: #d4cfc4;
  --bubble-user: #0d0d0f;
  --shadow: 0 2px 12px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--paper);color:var(--ink);font-family:'Geist Mono',monospace;overflow:hidden;}

.shell{display:flex;flex-direction:column;height:100dvh;max-width:680px;margin:0 auto;background:var(--paper);position:relative;}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 12px;border-bottom:1px solid var(--border);background:var(--paper);flex-shrink:0;position:relative;z-index:10;}
.agent-id{display:flex;align-items:center;gap:10px;}
.avatar{width:36px;height:36px;background:var(--ink);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.agent-name{font-family:'Instrument Serif',serif;font-size:17px;color:var(--ink);line-height:1.1;}
.agent-sub{font-size:10px;color:var(--muted);letter-spacing:0.06em;text-transform:uppercase;}
.topbar-actions{display:flex;gap:8px;align-items:center;}
.icon-btn{width:34px;height:34px;background:var(--paper2);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:background 0.15s;}
.icon-btn:hover{background:var(--paper3);}

/* SETUP OVERLAY */
.setup-overlay{position:absolute;inset:0;background:var(--paper);z-index:100;overflow-y:auto;padding:24px 18px 40px;display:none;}
.setup-overlay.open{display:block;}
.setup-title{font-family:'Instrument Serif',serif;font-size:26px;margin-bottom:6px;line-height:1.2;}
.setup-sub{font-size:11px;color:var(--muted);margin-bottom:28px;line-height:1.6;}
.setup-section{margin-bottom:22px;}
.setup-label{font-size:10px;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:6px;display:block;}
.setup-input{width:100%;background:white;border:1px solid var(--border);border-radius:10px;padding:12px 14px;font-family:'Geist Mono',monospace;font-size:13px;color:var(--ink);outline:none;transition:border-color 0.2s;-webkit-appearance:none;}
.setup-input:focus{border-color:var(--ink);}
.setup-input::placeholder{color:var(--muted);}
textarea.setup-input{min-height:90px;resize:vertical;line-height:1.5;}
.repo-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.save-btn{width:100%;background:var(--ink);color:var(--paper);border:none;border-radius:10px;padding:15px;font-family:'Instrument Serif',serif;font-size:17px;cursor:pointer;transition:opacity 0.2s;margin-top:8px;}
.save-btn:hover{opacity:0.85;}
.memory-display{background:white;border:1px solid var(--border);border-radius:10px;padding:14px;font-size:12px;color:var(--muted);line-height:1.7;min-height:60px;white-space:pre-wrap;word-break:break-word;}
.clear-btn{background:transparent;border:1px solid #e0a0a0;color:#c04040;border-radius:8px;padding:8px 16px;font-family:'Geist Mono',monospace;font-size:11px;cursor:pointer;margin-top:8px;transition:background 0.15s;}
.clear-btn:hover{background:#fff0f0;}
.secure-badge{display:inline-flex;align-items:center;gap:5px;background:#f0f9f4;border:1px solid #a8dfc0;border-radius:8px;padding:8px 12px;font-size:11px;color:var(--accent2);margin-bottom:20px;}

/* MESSAGES */
.messages{flex:1;overflow-y:auto;padding:20px 18px 10px;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth;}
.messages::-webkit-scrollbar{width:3px;}
.messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

.welcome{text-align:center;padding:30px 10px 10px;}
.welcome-icon{font-size:44px;margin-bottom:14px;}
.welcome h2{font-family:'Instrument Serif',serif;font-size:22px;margin-bottom:8px;color:var(--ink);}
.welcome p{font-size:12px;color:var(--muted);line-height:1.7;max-width:320px;margin:0 auto 20px;}
.suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:4px;}
.suggestion{background:white;border:1px solid var(--border);border-radius:20px;padding:8px 14px;font-size:12px;color:var(--ink);cursor:pointer;transition:all 0.15s;font-family:'Geist Mono',monospace;}
.suggestion:hover{background:var(--ink);color:var(--paper);border-color:var(--ink);}

.msg{display:flex;gap:10px;align-items:flex-end;animation:msgIn 0.25s ease-out;}
@keyframes msgIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.msg.user{flex-direction:row-reverse;}
.msg-avatar{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;margin-bottom:2px;}
.msg.ai .msg-avatar{background:var(--ink);}
.msg.user .msg-avatar{background:var(--accent);}
.bubble{max-width:82%;padding:12px 15px;border-radius:16px;font-size:13.5px;line-height:1.65;word-break:break-word;}
.msg.ai .bubble{background:white;border:1px solid var(--border);border-bottom-left-radius:4px;color:var(--ink);box-shadow:var(--shadow);}
.msg.user .bubble{background:var(--bubble-user);color:#f5f2eb;border-bottom-right-radius:4px;}
.bubble pre{background:var(--paper2);border:1px solid var(--border);border-radius:6px;padding:10px;font-size:11px;overflow-x:auto;margin:8px 0;white-space:pre-wrap;word-break:break-word;}
.bubble code{background:var(--paper2);padding:1px 5px;border-radius:4px;font-size:12px;}
.bubble strong{font-weight:600;}
.bubble .action-btn{display:inline-block;background:var(--accent);color:white;border:none;border-radius:8px;padding:8px 16px;font-family:'Geist Mono',monospace;font-size:12px;cursor:pointer;margin-top:10px;margin-right:8px;transition:opacity 0.15s;}
.bubble .action-btn:hover{opacity:0.85;}
.bubble .action-btn.green{background:var(--accent2);}
.bubble .action-btn.blue{background:var(--accent3);}

.typing{display:flex;gap:10px;align-items:flex-end;}
.typing-dots{background:white;border:1px solid var(--border);border-radius:16px;border-bottom-left-radius:4px;padding:14px 18px;display:flex;gap:5px;align-items:center;}
.typing-dots span{width:6px;height:6px;background:var(--muted);border-radius:50%;animation:dot 1.2s infinite;}
.typing-dots span:nth-child(2){animation-delay:0.2s;}
.typing-dots span:nth-child(3){animation-delay:0.4s;}
@keyframes dot{0%,60%,100%{transform:translateY(0);opacity:0.4;}30%{transform:translateY(-5px);opacity:1;}}

.deploy-progress{margin-top:10px;}
.deploy-bar-wrap{background:var(--paper2);border-radius:100px;height:5px;overflow:hidden;margin-bottom:5px;}
.deploy-bar{height:100%;background:linear-gradient(90deg,var(--accent2),#38c96a);border-radius:100px;transition:width 0.4s ease;width:0%;}
.deploy-label{font-size:11px;color:var(--muted);}
.deploy-log{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.8;max-height:160px;overflow-y:auto;}
.deploy-log .ok{color:var(--accent2);}
.deploy-log .err{color:#c04040;}
.deploy-log .info{color:var(--accent3);}

/* INPUT */
.input-area{padding:12px 14px 16px;padding-bottom:max(16px,env(safe-area-inset-bottom));border-top:1px solid var(--border);background:var(--paper);flex-shrink:0;}
.input-row{display:flex;gap:8px;align-items:flex-end;background:white;border:1.5px solid var(--border);border-radius:14px;padding:8px 8px 8px 14px;transition:border-color 0.2s;}
.input-row:focus-within{border-color:var(--ink);}
#userInput{flex:1;border:none;background:transparent;font-family:'Geist Mono',monospace;font-size:14px;color:var(--ink);outline:none;resize:none;max-height:120px;line-height:1.5;padding:4px 0;}
#userInput::placeholder{color:var(--muted);}
.send-btn{width:36px;height:36px;background:var(--ink);border:none;border-radius:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:opacity 0.15s,transform 0.1s;color:white;}
.send-btn:hover{opacity:0.8;}
.send-btn:active{transform:scale(0.94);}
.send-btn:disabled{opacity:0.3;cursor:not-allowed;transform:none;}
.send-btn svg{width:16px;height:16px;fill:currentColor;}

.status-pill{display:inline-flex;align-items:center;gap:5px;font-size:10px;color:var(--muted);padding:3px 8px;border-radius:100px;background:var(--paper2);border:1px solid var(--border);margin-bottom:8px;}
.status-dot{width:5px;height:5px;border-radius:50%;background:#aaa;}
.status-dot.ready{background:var(--accent2);animation:pulse 2s infinite;}
.status-dot.thinking{background:var(--accent);animation:pulse 0.8s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.3;}}
</style>
</head>
<body>
<div class="shell">

  <!-- SETUP OVERLAY -->
  <div class="setup-overlay" id="setupOverlay">
    <div class="setup-title">Setup Your Agent</div>
    <div class="secure-badge">ğŸ”’ API keys live only on the server â€” never in your browser</div>
    <p class="setup-sub">Your name, repo, and preferences are saved in your browser. API keys (Gemini, OpenAI, GitHub) are stored securely as Vercel environment variables â€” they never leave the server.</p>

    <div class="setup-section">
      <label class="setup-label">Your Name</label>
      <input class="setup-input" id="s_name" placeholder="e.g. Fahad"/>
    </div>

    <div class="setup-section">
      <label class="setup-label">Active AI Brain</label>
      <select class="setup-input" id="s_brain">
        <option value="gemini">Google Gemini (Free â€” AI Studio)</option>
        <option value="openai">OpenAI GPT-4o-mini (Paid)</option>
      </select>
      <p style="font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5;">Both Gemini and OpenAI keys are already configured on the server. Switch brain anytime.</p>
    </div>

    <div class="setup-section">
      <label class="setup-label">Your GitHub Repo</label>
      <div class="repo-row">
        <input class="setup-input" id="s_repo1" placeholder="owner/repo" value="Fadjumah/rose-gallery-hub-18"/>
        <input class="setup-input" id="s_repo1_name" placeholder="Nickname e.g. ENT Site"/>
      </div>
    </div>

    <div class="setup-section">
      <label class="setup-label">About You & Your Projects</label>
      <textarea class="setup-input" id="s_about" placeholder="e.g. I run a medical ENT clinic website in Uganda called eritageentcare.com. I'm not a developer. I prefer plain explanations..."></textarea>
    </div>

    <div class="setup-section">
      <label class="setup-label">Your Preferences</label>
      <textarea class="setup-input" id="s_prefs" placeholder="e.g. Always explain what you're doing before doing it. Warn me before deleting anything..."></textarea>
    </div>

    <div class="setup-section">
      <label class="setup-label">What I Remember About You</label>
      <div class="memory-display" id="memoryDisplay">Nothing saved yet.</div>
      <button class="clear-btn" onclick="clearMemory()">ğŸ—‘ Clear All Memory</button>
    </div>

    <button class="save-btn" onclick="saveSetup()">Save & Start Chatting â†’</button>
  </div>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="agent-id">
      <div class="avatar">ğŸ¤–</div>
      <div>
        <div class="agent-name" id="agentName">My AI Agent</div>
        <div class="agent-sub" id="agentSub">Personal Assistant</div>
      </div>
    </div>
    <div class="topbar-actions">
      <div class="icon-btn" onclick="openSetup()" title="Settings">âš™ï¸</div>
      <div class="icon-btn" onclick="clearChat()" title="New chat">âœï¸</div>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="messages" id="messages">
    <div class="welcome" id="welcomeMsg">
      <div class="welcome-icon">ğŸ¤–</div>
      <h2>Hey, I'm your AI Agent</h2>
      <p>I know your sites, remember your preferences, and can push changes directly to GitHub. Just talk to me in plain language.</p>
      <div class="suggestions">
        <div class="suggestion" onclick="quickSend('What sites do you know about?')">What sites do you know?</div>
        <div class="suggestion" onclick="quickSend('Deploy all the Eritage ENT fixes to GitHub now')">Deploy ENT fixes</div>
        <div class="suggestion" onclick="quickSend('What do you remember about me?')">What do you know about me?</div>
        <div class="suggestion" onclick="quickSend('How do I add a new blog post to my site?')">How to add blog post</div>
      </div>
    </div>
  </div>

  <!-- STATUS -->
  <div style="padding:0 14px 4px;display:flex;align-items:center;">
    <div class="status-pill">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Ready</span>
    </div>
  </div>

  <!-- INPUT -->
  <div class="input-area">
    <div class="input-row">
      <textarea id="userInput" rows="1" placeholder="Ask me anything or give me a task..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

</div>
<script>
// â”€â”€ MEMORY (browser localStorage â€” no keys stored here) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MEM = 'aiagent_v3';
const mem = () => { try { return JSON.parse(localStorage.getItem(MEM)||'{}'); } catch { return {}; } };
const saveMem = d => localStorage.setItem(MEM, JSON.stringify(d));
const get = (k, def=null) => mem()[k] ?? def;
const set = (k, v) => { const m=mem(); m[k]=v; saveMem(m); };

function clearMemory() {
  if (!confirm('Clear all memory? This removes your name, repo settings and chat history.')) return;
  localStorage.removeItem(MEM);
  loadForm();
  addAI('Memory cleared. Tap âš™ï¸ to set up again.');
}

function pushConvo(role, content) {
  const h = get('conversation', []);
  h.push({ role, content, time: Date.now() });
  if (h.length > 40) h.splice(0, h.length - 40);
  set('conversation', h);
}

// â”€â”€ SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSetup()  { loadForm(); document.getElementById('setupOverlay').classList.add('open'); }
function closeSetup() { document.getElementById('setupOverlay').classList.remove('open'); }

function loadForm() {
  document.getElementById('s_name').value       = get('userName','');
  document.getElementById('s_brain').value      = get('brain','gemini');
  document.getElementById('s_repo1').value      = get('repo1','Fadjumah/rose-gallery-hub-18');
  document.getElementById('s_repo1_name').value = get('repo1name','');
  document.getElementById('s_about').value      = get('about','');
  document.getElementById('s_prefs').value      = get('prefs','');
  const m = mem();
  const txt = Object.entries(m)
    .filter(([k]) => !['conversation'].includes(k))
    .map(([k,v]) => `${k}: ${typeof v==='object'?JSON.stringify(v):v}`)
    .join('\n') || 'Nothing saved yet.';
  document.getElementById('memoryDisplay').textContent = txt;
}

function saveSetup() {
  set('userName',  document.getElementById('s_name').value.trim());
  set('brain',     document.getElementById('s_brain').value);
  set('repo1',     document.getElementById('s_repo1').value.trim());
  set('repo1name', document.getElementById('s_repo1_name').value.trim());
  set('about',     document.getElementById('s_about').value.trim());
  set('prefs',     document.getElementById('s_prefs').value.trim());
  set('setupDone', true);
  closeSetup();
  updateStatus();
  const n = get('userName','');
  addAI(`âœ… All saved${n?', '+n:''}! I know your sites and preferences now. What would you like to do?`);
}

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStatus() {
  const n  = get('userName','');
  const rn = get('repo1name','');
  document.getElementById('statusDot').className = 'status-dot ready';
  document.getElementById('statusText').textContent = 'Ready' + (rn?' Â· '+rn:'') + (n?' Â· '+n:'');
  if (n)  document.getElementById('agentName').textContent = n+"'s Agent";
  if (rn) document.getElementById('agentSub').textContent  = rn;
}

function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; }
function handleKey(e)   { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }
function quickSend(t)   { document.getElementById('userInput').value=t; sendMessage(); }
function scrollBot()    { const m=document.getElementById('messages'); setTimeout(()=>m.scrollTop=m.scrollHeight,50); }

function clearChat() {
  const msgs=document.getElementById('messages'); msgs.innerHTML='';
  const w=document.createElement('div'); w.className='welcome'; w.id='welcomeMsg';
  w.innerHTML='<div class="welcome-icon">ğŸ¤–</div><h2>Fresh start</h2><p>What would you like to do?</p>';
  msgs.appendChild(w);
}

function addUser(text) {
  const el=document.getElementById('welcomeMsg'); if(el) el.remove();
  const msgs=document.getElementById('messages');
  const d=document.createElement('div'); d.className='msg user';
  d.innerHTML=`<div class="msg-avatar">ğŸ‘¤</div><div class="bubble">${esc(text)}</div>`;
  msgs.appendChild(d); scrollBot();
}

function addAI(html) {
  const msgs=document.getElementById('messages');
  const d=document.createElement('div'); d.className='msg ai';
  d.innerHTML=`<div class="msg-avatar">ğŸ¤–</div><div class="bubble">${html}</div>`;
  msgs.appendChild(d); scrollBot(); return d;
}

function showTyping() {
  const msgs=document.getElementById('messages');
  const d=document.createElement('div'); d.className='typing'; d.id='typing';
  d.innerHTML='<div class="msg-avatar" style="width:28px;height:28px;border-radius:8px;background:var(--ink);display:flex;align-items:center;justify-content:center;font-size:13px;">ğŸ¤–</div><div class="typing-dots"><span></span><span></span><span></span></div>';
  msgs.appendChild(d); scrollBot();
}
function hideTyping() { const t=document.getElementById('typing'); if(t) t.remove(); }

function esc(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br/>');
}

function fmt(text) {
  text = text.replace(/```([\s\S]*?)```/g,'<pre>$1</pre>');
  text = text.replace(/`([^`]+)`/g,'<code>$1</code>');
  text = text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  text = text.replace(/\n/g,'<br/>');
  return text;
}

// â”€â”€ SYSTEM PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sysPrompt() {
  const name  = get('userName','the user');
  const repo1 = get('repo1','');
  const r1n   = get('repo1name','');
  const about = get('about','');
  const prefs = get('prefs','');
  const facts = get('learnedFacts',[]);
  const now   = new Date();
  const dateStr = now.toLocaleDateString('en-GB',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const timeStr = now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',timeZoneName:'short'});

  return `You are a personal AI agent for ${name}. You have real GitHub access, persistent memory, and help manage and deploy code using plain conversational language.

TODAY: ${dateStr} at ${timeStr}

ABOUT ${name.toUpperCase()}:
${about||'Not provided yet.'}

PREFERENCES:
${prefs||'Not set yet.'}

CONFIGURED GITHUB REPO:
- ${r1n||'Main repo'}: ${repo1}

THINGS YOU KNOW ABOUT THEM:
${facts.length?facts.join('\n'):'Nothing yet â€” learn as you chat.'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
YOUR REAL GITHUB CAPABILITIES:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
You have a real GitHub Personal Access Token configured on the server. It gives you ACTUAL access to GitHub. You can:

1. LIST ALL REPOS â€” See every repository in the account
2. READ ANY FILE â€” View the full content of any file in any repo
3. LIST COMMITS â€” See recent commit history of any repo
4. PUSH/UPDATE FILES â€” Write changes directly to any repo
5. CREATE NEW FILES â€” Add new files to any repo

To use these GitHub capabilities, append one of these action blocks AFTER your normal reply:

LIST ALL REPOS:
[ACTION:GITHUB]{"action":"listRepos"}[/ACTION:GITHUB]

GET REPO INFO:
[ACTION:GITHUB]{"action":"getRepo","repo":"owner/reponame"}[/ACTION:GITHUB]

READ A FILE:
[ACTION:GITHUB]{"action":"getFile","repo":"owner/reponame","path":"index.html","branch":"main"}[/ACTION:GITHUB]

LIST RECENT COMMITS:
[ACTION:GITHUB]{"action":"listCommits","repo":"owner/reponame","branch":"main","limit":10}[/ACTION:GITHUB]

LIST FILES IN A FOLDER:
[ACTION:GITHUB]{"action":"listFiles","repo":"owner/reponame","path":"","branch":"main"}[/ACTION:GITHUB]

DEPLOY/PUSH FILES:
[ACTION:DEPLOY]
{"repo":"owner/reponame","branch":"main","commit_message":"your message","files":[{"path":"file/path","content":"full content here"}]}
[/ACTION:DEPLOY]

IMPORTANT â€” HOW GITHUB DATA WORKS:
When Fahad asks about repos, commits, or files, the system automatically fetches the real data from GitHub BEFORE sending you this message. If you see a "LIVE GITHUB DATA" section in the message, that is real, accurate, current data â€” use it immediately to answer. NEVER say you are "waiting" for data, "sending a request", or that it will take a few seconds. If the data is there, answer from it directly. If no data was fetched and you need it, use an [ACTION:GITHUB] block to request it.

WHEN YOU LEARN AN IMPORTANT NEW FACT ABOUT THE USER, append:
[MEMORY]the fact[/MEMORY]

PERSONALITY: Warm, direct, plain language. Trusted technical friend. Always say what you're about to do. Never delete without confirmation.`;
}

// â”€â”€ AI CALL (via secure backend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callAI(userMsg) {
  const provider = get('brain','gemini');
  const history  = get('conversation',[]).slice(-20);

  const r = await fetch('/api/ai', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      provider,
      systemPrompt: sysPrompt(),
      history,
      userMessage: userMsg,
    }),
  });

  const data = await r.json();
  if (!r.ok) throw new Error(data.error || `Server error: HTTP ${r.status}`);
  if (!data.response) throw new Error('Empty response from server.');
  return data.response;
}

// â”€â”€ GITHUB ENGINE (via secure backend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function githubAPI(payload) {
  const r = await fetch('/api/github', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || `GitHub error: HTTP ${r.status}`);
  return data;
}

async function pushFile(repo, branch, path, content, commitMessage) {
  return await githubAPI({ action: 'pushFile', repo, branch, path, content, commitMessage });
}

async function executeDeploy(action, msgEl) {
  const { repo, branch, commit_message, files } = action;
  const bubble = msgEl.querySelector('.bubble');
  let log = '';
  const appendLog = (line, cls='') => {
    log += `<div class="${cls}">${line}</div>`;
    bubble.querySelector('.deploy-log').innerHTML = log;
    scrollBot();
  };
  bubble.innerHTML = `<strong>ğŸš€ Deploying to GitHub...</strong><div class="deploy-progress"><div class="deploy-bar-wrap"><div class="deploy-bar" id="dBar"></div></div><div class="deploy-label" id="dLabel">Starting...</div></div><div class="deploy-log"></div>`;

  for (let i=0; i<files.length; i++) {
    const f = files[i];
    document.getElementById('dBar').style.width = Math.round((i/files.length)*100)+'%';
    document.getElementById('dLabel').textContent = `${i}/${files.length} â€” ${f.path}`;
    appendLog(`â†’ ${f.path}`, 'info');
    try {
      await pushFile(repo, branch||'main', f.path, f.content, commit_message||`update: ${f.path}`);
      appendLog('  âœ… pushed', 'ok');
    } catch(e) {
      appendLog(`  âŒ ${e.message}`, 'err');
    }
    await new Promise(r => setTimeout(r, 280));
  }

  document.getElementById('dBar').style.width = '100%';
  document.getElementById('dLabel').textContent = `${files.length}/${files.length} complete`;
  appendLog('', '');
  appendLog('ğŸ‰ Done! Vercel will rebuild in ~60 seconds.', 'ok');
  scrollBot();
}

// â”€â”€ RESPONSE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleResponse(raw, msgEl) {
  // Save [MEMORY] blocks
  for (const m of raw.matchAll(/\[MEMORY\]([\s\S]*?)\[\/MEMORY\]/g)) {
    const fact = m[1].trim();
    const facts = get('learnedFacts',[]);
    if (!facts.includes(fact)) { facts.push(fact); set('learnedFacts', facts); }
  }

  // Handle [ACTION:GITHUB] â€” read operations, feed result back to AI
  const ghMatch = raw.match(/\[ACTION:GITHUB\]([\s\S]*?)\[\/ACTION:GITHUB\]/);

  // Handle [ACTION:DEPLOY] â€” write operations, show confirmation
  const deployMatch = raw.match(/\[ACTION:DEPLOY\]([\s\S]*?)\[\/ACTION:DEPLOY\]/);

  // Clean display text
  const displayText = raw
    .replace(/\[MEMORY\][\s\S]*?\[\/MEMORY\]/g,'')
    .replace(/\[ACTION:GITHUB\][\s\S]*?\[\/ACTION:GITHUB\]/g,'')
    .replace(/\[ACTION:DEPLOY\][\s\S]*?\[\/ACTION:DEPLOY\]/g,'')
    .trim();

  if (displayText) {
    msgEl.querySelector('.bubble').innerHTML = fmt(displayText);
  }
  scrollBot();

  // â”€â”€ Process GitHub READ action â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (ghMatch) {
    let ghPayload;
    try { ghPayload = JSON.parse(ghMatch[1].trim()); }
    catch(e) { addAI(`âš ï¸ Couldn't parse GitHub action: ${e.message}`); return; }

    // Show a "fetching" indicator
    const fetchEl = addAI(`<em>ğŸ” Fetching from GitHub (${ghPayload.action})â€¦</em>`);
    let ghResult;
    try {
      ghResult = await githubAPI(ghPayload);
      fetchEl.querySelector('.bubble').innerHTML = `<em>âœ… Got data from GitHub â€” summarisingâ€¦</em>`;
    } catch(e) {
      fetchEl.querySelector('.bubble').innerHTML = `âŒ GitHub error: ${esc(e.message)}`;
      return;
    }

    // Feed the result back into the AI so it can summarise it naturally
    const resultStr = JSON.stringify(ghResult, null, 2);
    const followUpMsg = `Here is the real data from GitHub for the ${ghPayload.action} request:\n\n${resultStr}\n\nPlease summarise this clearly and helpfully for me in plain language.`;

    showTyping();
    try {
      // Add to history so AI has context
      pushConvo('assistant', raw);
      pushConvo('user', followUpMsg);
      const summaryResponse = await callAI(followUpMsg);
      hideTyping();
      fetchEl.querySelector('.bubble').innerHTML = fmt(summaryResponse.replace(/\[ACTION:GITHUB\][\s\S]*?\[\/ACTION:GITHUB\]/g,'').replace(/\[MEMORY\][\s\S]*?\[\/MEMORY\]/g,'').trim());
      pushConvo('assistant', summaryResponse);
    } catch(e) {
      hideTyping();
      fetchEl.querySelector('.bubble').innerHTML = `âŒ Error summarising: ${esc(e.message)}`;
    }
    scrollBot();
    return; // Don't process deploy in same turn
  }

  // â”€â”€ Process GitHub DEPLOY action â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (deployMatch) {
    try {
      const action = JSON.parse(deployMatch[1].trim());
      const cnt = action.files?.length||0;
      const safeAction = JSON.stringify(action).replace(/"/g,'&quot;');
      addAI(`<strong>Ready to deploy ${cnt} file(s) to <code>${action.repo}</code></strong><br/><br/>Shall I go ahead?<br/><button class="action-btn green" onclick="confirmDeploy(this,'${safeAction}')">âœ… Yes, deploy now</button><button class="action-btn" onclick="this.closest('.msg').remove()">âŒ Cancel</button>`);
    } catch(e) {
      addAI(`âš ï¸ I planned a deploy but couldn't parse it: ${e.message}. Please try again.`);
    }
  }
}

async function confirmDeploy(btn, actionStr) {
  btn.parentNode.innerHTML = '<em>Deployingâ€¦</em>';
  const action = JSON.parse(actionStr.replace(/&quot;/g,'"'));
  const el = addAI('<strong>ğŸš€ Startingâ€¦</strong>');
  try { await executeDeploy(action, el); }
  catch(e) { el.querySelector('.bubble').innerHTML = `âŒ Deploy failed: ${e.message}`; }
}

// â”€â”€ INTENT DETECTION â€” fetch real GitHub data BEFORE calling AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const REPO_INTENTS   = /\b(repos?|repositories|repository|projects?|github\s+acc|what.*(have|do i have)|list|show me|how many)\b/i;
const FILE_INTENTS   = /\b(read|view|show|open|look at|content of|what.?s in)\b.*\.(html|css|js|md|json|txt|py)\b/i;
const COMMIT_INTENTS = /\b(commits?|history|changes|what.*(changed|updated|last|recent))\b/i;

async function prefetchGitHubContext(text) {
  // Returns a string to inject into the AI prompt, or null if no prefetch needed
  try {
    if (REPO_INTENTS.test(text) && /repo|repositor|github|projects?/i.test(text)) {
      const data = await githubAPI({ action: 'listRepos' });
      if (!data.repos) return null;
      const lines = data.repos.map(r =>
        `â€¢ ${r.name}${r.description ? ' â€” ' + r.description : ''}${r.language ? ' ['+r.language+']' : ''}  (updated: ${r.updatedAt?.slice(0,10)||'?'})`
      ).join('\n');
      return `LIVE GITHUB DATA (fetched right now):\nYou have ${data.total} repositor${data.total===1?'y':'ies'}:\n${lines}`;
    }

    if (COMMIT_INTENTS.test(text)) {
      const repo = get('repo1','');
      if (!repo) return null;
      const data = await githubAPI({ action: 'listCommits', repo, limit: 8 });
      if (!data.commits) return null;
      const lines = data.commits.map(c => `â€¢ [${c.sha}] ${c.date?.slice(0,10)} â€” ${c.message} (by ${c.author})`).join('\n');
      return `LIVE GITHUB DATA â€” Recent commits for ${repo}:\n${lines}`;
    }
  } catch(e) {
    // Prefetch failed silently â€” AI will respond without it
    console.warn('Prefetch failed:', e.message);
  }
  return null;
}

// â”€â”€ MAIN SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const inp  = document.getElementById('userInput');
  const text = inp.value.trim(); if (!text) return;
  const btn  = document.getElementById('sendBtn');
  btn.disabled = true; inp.value = ''; inp.style.height = 'auto';
  addUser(text); pushConvo('user', text);
  document.getElementById('statusDot').className = 'status-dot thinking';
  document.getElementById('statusText').textContent = 'Thinkingâ€¦';
  showTyping();

  try {
    // Pre-fetch real GitHub data if the message seems to need it
    const githubContext = await prefetchGitHubContext(text);

    // Inject the live data directly into the user message so AI has it immediately
    const augmentedMessage = githubContext
      ? `${text}\n\n---\n${githubContext}\n---\nPlease use the above live data to answer my question accurately.`
      : text;

    const response = await callAI(augmentedMessage);
    hideTyping();
    const el = addAI('');
    await handleResponse(response, el);
    // Store original message in history (not the augmented one)
    pushConvo('assistant', response);
  } catch(e) {
    hideTyping();
    addAI(`âŒ <strong>Error:</strong> ${esc(e.message)}`);
  }
  btn.disabled = false; updateStatus(); inp.focus();
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
  updateStatus();
  if (!get('setupDone')) setTimeout(openSetup, 500);
};
</script>
</body>
</html>

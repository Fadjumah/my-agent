<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>My AI Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Geist+Mono:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --ink: #0d0d0f;
  --paper: #f5f2eb;
  --paper2: #ede9df;
  --paper3: #e4dfd3;
  --accent: #c8410a;
  --accent2: #1a6b3a;
  --accent3: #1a3a6b;
  --muted: #8a8578;
  --border: #d4cfc4;
  --bubble-user: #0d0d0f;
  --shadow: 0 2px 12px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--paper);color:var(--ink);font-family:'Geist Mono',monospace;overflow:hidden;}
.shell{display:flex;flex-direction:column;height:100dvh;max-width:680px;margin:0 auto;background:var(--paper);position:relative;}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 12px;border-bottom:1px solid var(--border);background:var(--paper);flex-shrink:0;position:relative;z-index:10;}
.agent-id{display:flex;align-items:center;gap:10px;}
.avatar{width:36px;height:36px;background:var(--ink);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.agent-name{font-family:'Instrument Serif',serif;font-size:17px;color:var(--ink);line-height:1.1;}
.agent-sub{font-size:10px;color:var(--muted);letter-spacing:0.06em;text-transform:uppercase;}
.topbar-actions{display:flex;gap:8px;align-items:center;}
.icon-btn{width:34px;height:34px;background:var(--paper2);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:background 0.15s;}
.icon-btn:hover{background:var(--paper3);}

/* SETUP */
.setup-overlay{position:absolute;inset:0;background:var(--paper);z-index:100;overflow-y:auto;padding:24px 18px 40px;display:none;}
.setup-overlay.open{display:block;}
.setup-title{font-family:'Instrument Serif',serif;font-size:26px;margin-bottom:6px;line-height:1.2;}
.setup-sub{font-size:11px;color:var(--muted);margin-bottom:28px;line-height:1.6;}
.setup-section{margin-bottom:22px;}
.setup-label{font-size:10px;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:6px;display:block;}
.setup-input{width:100%;background:white;border:1px solid var(--border);border-radius:10px;padding:12px 14px;font-family:'Geist Mono',monospace;font-size:13px;color:var(--ink);outline:none;transition:border-color 0.2s;-webkit-appearance:none;}
.setup-input:focus{border-color:var(--ink);}
.setup-input::placeholder{color:var(--muted);}
textarea.setup-input{min-height:90px;resize:vertical;line-height:1.5;}
.repo-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.save-btn{width:100%;background:var(--ink);color:var(--paper);border:none;border-radius:10px;padding:15px;font-family:'Instrument Serif',serif;font-size:17px;cursor:pointer;transition:opacity 0.2s;margin-top:8px;}
.save-btn:hover{opacity:0.85;}
.memory-display{background:white;border:1px solid var(--border);border-radius:10px;padding:14px;font-size:12px;color:var(--muted);line-height:1.7;min-height:60px;white-space:pre-wrap;word-break:break-word;}
.clear-btn{background:transparent;border:1px solid #e0a0a0;color:#c04040;border-radius:8px;padding:8px 16px;font-family:'Geist Mono',monospace;font-size:11px;cursor:pointer;margin-top:8px;transition:background 0.15s;}
.clear-btn:hover{background:#fff0f0;}
.secure-badge{display:inline-flex;align-items:center;gap:5px;background:#f0f9f4;border:1px solid #a8dfc0;border-radius:8px;padding:8px 12px;font-size:11px;color:var(--accent2);margin-bottom:20px;}

/* MESSAGES */
.messages{flex:1;overflow-y:auto;padding:20px 18px 10px;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth;}
.messages::-webkit-scrollbar{width:3px;}
.messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
.welcome{text-align:center;padding:30px 10px 10px;}
.welcome-icon{font-size:44px;margin-bottom:14px;}
.welcome h2{font-family:'Instrument Serif',serif;font-size:22px;margin-bottom:8px;color:var(--ink);}
.welcome p{font-size:12px;color:var(--muted);line-height:1.7;max-width:320px;margin:0 auto 20px;}
.suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:4px;}
.suggestion{background:white;border:1px solid var(--border);border-radius:20px;padding:8px 14px;font-size:12px;color:var(--ink);cursor:pointer;transition:all 0.15s;font-family:'Geist Mono',monospace;}
.suggestion:hover{background:var(--ink);color:var(--paper);border-color:var(--ink);}
.msg{display:flex;gap:10px;align-items:flex-end;animation:msgIn 0.25s ease-out;}
@keyframes msgIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.msg.user{flex-direction:row-reverse;}
.msg-avatar{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;margin-bottom:2px;}
.msg.ai .msg-avatar{background:var(--ink);}
.msg.user .msg-avatar{background:var(--accent);}
.bubble{max-width:82%;padding:12px 15px;border-radius:16px;font-size:13.5px;line-height:1.65;word-break:break-word;}
.msg.ai .bubble{background:white;border:1px solid var(--border);border-bottom-left-radius:4px;color:var(--ink);box-shadow:var(--shadow);}
.msg.user .bubble{background:var(--bubble-user);color:#f5f2eb;border-bottom-right-radius:4px;}
.bubble pre{background:var(--paper2);border:1px solid var(--border);border-radius:6px;padding:10px;font-size:11px;overflow-x:auto;margin:8px 0;white-space:pre-wrap;word-break:break-word;}
.bubble code{background:var(--paper2);padding:1px 5px;border-radius:4px;font-size:12px;}
.bubble strong{font-weight:600;}
.bubble a{color:var(--accent3);}
.bubble .action-btn{display:inline-block;background:var(--accent);color:white;border:none;border-radius:8px;padding:8px 16px;font-family:'Geist Mono',monospace;font-size:12px;cursor:pointer;margin-top:10px;margin-right:8px;transition:opacity 0.15s;}
.bubble .action-btn:hover{opacity:0.85;}
.bubble .action-btn.green{background:var(--accent2);}
.bubble .action-btn.blue{background:var(--accent3);}
.typing{display:flex;gap:10px;align-items:flex-end;}
.typing-dots{background:white;border:1px solid var(--border);border-radius:16px;border-bottom-left-radius:4px;padding:14px 18px;display:flex;gap:5px;align-items:center;}
.typing-dots span{width:6px;height:6px;background:var(--muted);border-radius:50%;animation:dot 1.2s infinite;}
.typing-dots span:nth-child(2){animation-delay:0.2s;}
.typing-dots span:nth-child(3){animation-delay:0.4s;}
@keyframes dot{0%,60%,100%{transform:translateY(0);opacity:0.4;}30%{transform:translateY(-5px);opacity:1;}}
.deploy-progress{margin-top:10px;}
.deploy-bar-wrap{background:var(--paper2);border-radius:100px;height:5px;overflow:hidden;margin-bottom:5px;}
.deploy-bar{height:100%;background:linear-gradient(90deg,var(--accent2),#38c96a);border-radius:100px;transition:width 0.4s ease;width:0%;}
.deploy-label{font-size:11px;color:var(--muted);}
.deploy-log{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.8;max-height:160px;overflow-y:auto;}
.deploy-log .ok{color:var(--accent2);}
.deploy-log .err{color:#c04040;}
.deploy-log .info{color:var(--accent3);}

/* INPUT */
.input-area{padding:12px 14px 16px;padding-bottom:max(16px,env(safe-area-inset-bottom));border-top:1px solid var(--border);background:var(--paper);flex-shrink:0;}
.input-row{display:flex;gap:8px;align-items:flex-end;background:white;border:1.5px solid var(--border);border-radius:14px;padding:8px 8px 8px 14px;transition:border-color 0.2s;}
.input-row:focus-within{border-color:var(--ink);}
#userInput{flex:1;border:none;background:transparent;font-family:'Geist Mono',monospace;font-size:14px;color:var(--ink);outline:none;resize:none;max-height:120px;line-height:1.5;padding:4px 0;}
#userInput::placeholder{color:var(--muted);}
.send-btn{width:36px;height:36px;background:var(--ink);border:none;border-radius:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:opacity 0.15s,transform 0.1s;color:white;}
.send-btn:hover{opacity:0.8;}
.send-btn:active{transform:scale(0.94);}
.send-btn:disabled{opacity:0.3;cursor:not-allowed;transform:none;}
.send-btn svg{width:16px;height:16px;fill:currentColor;}
.status-pill{display:inline-flex;align-items:center;gap:5px;font-size:10px;color:var(--muted);padding:3px 8px;border-radius:100px;background:var(--paper2);border:1px solid var(--border);margin-bottom:8px;}
.status-dot{width:5px;height:5px;border-radius:50%;background:#aaa;}
.status-dot.ready{background:var(--accent2);animation:pulse 2s infinite;}
.status-dot.thinking{background:var(--accent);animation:pulse 0.8s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.3;}}
</style>
</head>
<body>
<div class="shell">

  <!-- SETUP -->
  <div class="setup-overlay" id="setupOverlay">
    <div class="setup-title">Setup Your Agent</div>
    <div class="secure-badge">ğŸ”’ API keys live only on the server â€” never in your browser</div>
    <p class="setup-sub">Your name, repo, and preferences are saved locally. API keys (Gemini, OpenAI, GitHub) stay securely on Vercel's servers.</p>
    <div class="setup-section">
      <label class="setup-label">Your Name</label>
      <input class="setup-input" id="s_name" placeholder="e.g. Fahad"/>
    </div>
    <div class="setup-section">
      <label class="setup-label">Active AI Brain</label>
      <select class="setup-input" id="s_brain">
        <option value="gemini">Google Gemini (Free â€” AI Studio)</option>
        <option value="openai">OpenAI GPT-4o-mini (Paid)</option>
      </select>
      <p style="font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5;">Both keys are on the server. Switch anytime. If Gemini hits its daily limit, switch to OpenAI.</p>
    </div>
    <div class="setup-section">
      <label class="setup-label">Your GitHub Repo</label>
      <div class="repo-row">
        <input class="setup-input" id="s_repo1" placeholder="owner/repo"/>
        <input class="setup-input" id="s_repo1_name" placeholder="Nickname e.g. ENT Site"/>
      </div>
    </div>
    <div class="setup-section">
      <label class="setup-label">About You & Your Projects</label>
      <textarea class="setup-input" id="s_about" placeholder="Tell the agent about yourself, your clinic, your goals..."></textarea>
    </div>
    <div class="setup-section">
      <label class="setup-label">Your Preferences</label>
      <textarea class="setup-input" id="s_prefs" placeholder="e.g. Always explain before doing. Be direct. No jargon..."></textarea>
    </div>
    <div class="setup-section">
      <label class="setup-label">What I Remember About You</label>
      <div class="memory-display" id="memoryDisplay">Nothing saved yet.</div>
      <button class="clear-btn" onclick="clearMemory()">ğŸ—‘ Clear All Memory</button>
    </div>
    <button class="save-btn" onclick="saveSetup()">Save & Start Chatting â†’</button>
  </div>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="agent-id">
      <div class="avatar">ğŸ¤–</div>
      <div>
        <div class="agent-name" id="agentName">My AI Agent</div>
        <div class="agent-sub" id="agentSub">Personal Assistant</div>
      </div>
    </div>
    <div class="topbar-actions">
      <div class="icon-btn" onclick="openSetup()" title="Settings">âš™ï¸</div>
      <div class="icon-btn" onclick="clearChat()" title="New chat">âœï¸</div>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="messages" id="messages">
    <div class="welcome" id="welcomeMsg">
      <div class="welcome-icon">ğŸ¤–</div>
      <h2>Hey, I'm your AI Agent</h2>
      <p>I know your sites, remember your preferences, and can push changes directly to GitHub. Just talk to me in plain language.</p>
      <div class="suggestions">
        <div class="suggestion" onclick="quickSend('List all my GitHub repositories')">List my GitHub repos</div>
        <div class="suggestion" onclick="quickSend('What do you remember about me?')">What do you know about me?</div>
        <div class="suggestion" onclick="quickSend('What is today\'s date and time?')">Date & time</div>
        <div class="suggestion" onclick="quickSend('How do I add a new blog post to my site?')">How to add blog post</div>
      </div>
    </div>
  </div>

  <!-- STATUS -->
  <div style="padding:0 14px 4px;display:flex;align-items:center;">
    <div class="status-pill">
      <div class="status-dot ready" id="statusDot"></div>
      <span id="statusText">Ready</span>
    </div>
  </div>

  <!-- INPUT -->
  <div class="input-area">
    <div class="input-row">
      <textarea id="userInput" rows="1" placeholder="Ask me anything or give me a task..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MEM = 'aiagent_v3';
function mem()        { try { return JSON.parse(localStorage.getItem(MEM)||'{}'); } catch { return {}; } }
function saveMem(d)   { localStorage.setItem(MEM, JSON.stringify(d)); }
function get(k, def)  { const v = mem()[k]; return v !== undefined && v !== null ? v : (def !== undefined ? def : null); }
function set(k, v)    { const m = mem(); m[k] = v; saveMem(m); }

function clearMemory() {
  if (!confirm('Clear all memory? This removes your name, repo settings and chat history.')) return;
  localStorage.removeItem(MEM);
  loadForm();
  addAI('Memory cleared. Tap âš™ï¸ to set up again.');
}

function pushConvo(role, content) {
  const h = get('conversation', []);
  h.push({ role, content, time: Date.now() });
  if (h.length > 40) h.splice(0, h.length - 40);
  set('conversation', h);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSetup()  { loadForm(); document.getElementById('setupOverlay').classList.add('open'); }
function closeSetup() { document.getElementById('setupOverlay').classList.remove('open'); }

function loadForm() {
  document.getElementById('s_name').value       = get('userName','');
  document.getElementById('s_brain').value      = get('brain','gemini');
  document.getElementById('s_repo1').value      = get('repo1','');
  document.getElementById('s_repo1_name').value = get('repo1name','');
  document.getElementById('s_about').value      = get('about','');
  document.getElementById('s_prefs').value      = get('prefs','');
  const m   = mem();
  const txt = Object.entries(m)
    .filter(([k]) => k !== 'conversation')
    .map(([k,v]) => `${k}: ${typeof v === 'object' ? JSON.stringify(v) : v}`)
    .join('\n') || 'Nothing saved yet.';
  document.getElementById('memoryDisplay').textContent = txt;
}

function saveSetup() {
  set('userName',  document.getElementById('s_name').value.trim());
  set('brain',     document.getElementById('s_brain').value);
  set('repo1',     document.getElementById('s_repo1').value.trim());
  set('repo1name', document.getElementById('s_repo1_name').value.trim());
  set('about',     document.getElementById('s_about').value.trim());
  set('prefs',     document.getElementById('s_prefs').value.trim());
  set('setupDone', true);
  closeSetup();
  updateStatus();
  const n = get('userName','');
  addAI('âœ… All saved' + (n ? ', ' + n : '') + '! What would you like to do?');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStatus() {
  const n  = get('userName','');
  const rn = get('repo1name','');
  document.getElementById('statusDot').className  = 'status-dot ready';
  document.getElementById('statusText').textContent = 'Ready' + (rn ? ' Â· ' + rn : '') + (n ? ' Â· ' + n : '');
  if (n)  document.getElementById('agentName').textContent = n + "'s Agent";
  if (rn) document.getElementById('agentSub').textContent  = rn;
}

function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; }
function handleKey(e)   { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
function quickSend(t)   { document.getElementById('userInput').value = t; sendMessage(); }
function scrollBot()    { const m = document.getElementById('messages'); setTimeout(() => m.scrollTop = m.scrollHeight, 50); }

function clearChat() {
  document.getElementById('messages').innerHTML =
    '<div class="welcome" id="welcomeMsg"><div class="welcome-icon">ğŸ¤–</div><h2>Fresh start</h2><p>What would you like to do?</p></div>';
}

function addUser(text) {
  const el = document.getElementById('welcomeMsg'); if (el) el.remove();
  const msgs = document.getElementById('messages');
  const d = document.createElement('div');
  d.className = 'msg user';
  d.innerHTML = '<div class="msg-avatar">ğŸ‘¤</div><div class="bubble">' + esc(text) + '</div>';
  msgs.appendChild(d); scrollBot();
}

function addAI(html) {
  const msgs = document.getElementById('messages');
  const d = document.createElement('div');
  d.className = 'msg ai';
  d.innerHTML = '<div class="msg-avatar">ğŸ¤–</div><div class="bubble">' + html + '</div>';
  msgs.appendChild(d); scrollBot(); return d;
}

function showTyping() {
  const msgs = document.getElementById('messages');
  const d = document.createElement('div');
  d.className = 'typing'; d.id = 'typing';
  d.innerHTML = '<div class="msg-avatar" style="width:28px;height:28px;border-radius:8px;background:var(--ink);display:flex;align-items:center;justify-content:center;font-size:13px;">ğŸ¤–</div><div class="typing-dots"><span></span><span></span><span></span></div>';
  msgs.appendChild(d); scrollBot();
}
function hideTyping() { const t = document.getElementById('typing'); if (t) t.remove(); }

function esc(t) {
  return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br/>');
}

function fmt(text) {
  if (!text) return '';
  text = text.replace(/```[\s\S]*?```/g, m => '<pre>' + m.slice(3, m.lastIndexOf('```')).replace(/^[a-z]*\n/,'') + '</pre>');
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
  text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\n/g, '<br/>');
  return text;
}

function safeParseJSON(str) {
  const cleaned = String(str).trim()
    .replace(/^```json?\s*/i, '').replace(/```\s*$/, '')
    .replace(/^`+|`+$/g, '').trim();
  return JSON.parse(cleaned);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYSTEM PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sysPrompt() {
  const name  = get('userName', 'the user');
  const repo1 = get('repo1', '');
  const r1n   = get('repo1name', '');
  const about = get('about', '');
  const prefs = get('prefs', '');
  const facts = get('learnedFacts', []);
  const now   = new Date();
  const dateStr = now.toLocaleDateString('en-GB', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const timeStr = now.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',timeZoneName:'short'});

  return [
    'You are a personal AI agent for ' + name + '. You have real GitHub access, persistent memory, and help manage and deploy code in plain language.',
    '',
    'TODAY: ' + dateStr + ' at ' + timeStr,
    '',
    'ABOUT ' + name.toUpperCase() + ':',
    about || 'Not provided yet.',
    '',
    'PREFERENCES:',
    prefs || 'Not set yet.',
    '',
    'CONFIGURED GITHUB REPO:',
    '- ' + (r1n || 'Main repo') + ': ' + (repo1 || 'not set'),
    '',
    'THINGS YOU KNOW ABOUT THEM:',
    facts.length ? facts.join('\n') : 'Nothing yet â€” learn as you chat.',
    '',
    'GITHUB ACCESS:',
    'The system automatically fetches real GitHub data and injects it into your messages as LIVE GITHUB DATA.',
    'When you see LIVE GITHUB DATA â€” answer from it immediately. Do not say you are fetching, waiting, or sending a request.',
    'If no live data was injected and you need it, use ONE action block (no backticks, raw JSON only):',
    '[ACTION:GITHUB]{"action":"listRepos"}[/ACTION:GITHUB]',
    '[ACTION:GITHUB]{"action":"getFile","repo":"owner/repo","path":"index.html"}[/ACTION:GITHUB]',
    '[ACTION:GITHUB]{"action":"listCommits","repo":"owner/repo","limit":10}[/ACTION:GITHUB]',
    '',
    'To push file changes (always confirm first):',
    '[ACTION:DEPLOY]{"repo":"owner/repo","branch":"main","commit_message":"msg","files":[{"path":"file.html","content":"full content"}]}[/ACTION:DEPLOY]',
    '',
    'HARD RULES:',
    '- NEVER say you are waiting, fetching, or that data is coming. If you have it, use it. If you do not have it, say so plainly.',
    '- NEVER make up repository names, file contents, or commit history. Only state what is in LIVE GITHUB DATA.',
    '- NEVER push or delete without Fahad explicitly saying yes.',
    '- When you learn a fact about Fahad, append: [MEMORY]the fact[/MEMORY]',
    '',
    'PERSONALITY: Warm, direct, plain language. Trusted technical co-founder. Brief. Action-oriented.',
  ].join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATE LIMIT STATE + COUNTDOWN TIMER (Gemini only)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var geminiResetAt    = 0;   // timestamp ms when Gemini quota resets
var countdownInterval = null;
var messageQueue      = [];  // holds queued messages while quota is hit

function nextMidnightPacific() {
  // Gemini free tier resets at midnight US Pacific (approx UTC-8)
  var offset  = 8 * 60 * 60 * 1000;
  var pacific = new Date(Date.now() - offset);
  pacific.setHours(24, 0, 0, 0);
  return pacific.getTime() + offset;
}

function markGeminiLimited() {
  geminiResetAt = nextMidnightPacific();
  set('gemini_reset_at', geminiResetAt);
  startCountdown();
}

function isGeminiLimited() {
  if (!geminiResetAt) geminiResetAt = get('gemini_reset_at', 0);
  return geminiResetAt > Date.now();
}

function clearGeminiLimit() {
  geminiResetAt = 0;
  set('gemini_reset_at', 0);
}

function formatCountdown(ms) {
  if (ms <= 0) return '0s';
  var s = Math.floor(ms / 1000);
  var h = Math.floor(s / 3600); s -= h * 3600;
  var m = Math.floor(s / 60);   s -= m * 60;
  if (h > 0) return h + 'h ' + m + 'm';
  if (m > 0) return m + 'm ' + s + 's';
  return s + 's';
}

function startCountdown() {
  if (countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(function() {
    if (!isGeminiLimited()) {
      clearInterval(countdownInterval);
      countdownInterval = null;
      clearGeminiLimit();
      updateStatus();
      flushQueue();
      return;
    }
    var remaining = geminiResetAt - Date.now();
    document.getElementById('statusDot').className    = 'status-dot';
    document.getElementById('statusText').textContent =
      'â³ Gemini quota resets in ' + formatCountdown(remaining) + ' â€” messages queued';
  }, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGE QUEUE â€” auto-flushes when quota resets
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function queueMessage(text) {
  messageQueue.push(text);
  // Save queue to localStorage so it survives a page refresh
  set('msg_queue', messageQueue);
  var resetIn = formatCountdown(geminiResetAt - Date.now());
  addAI(
    'ğŸ“¥ <strong>Message saved.</strong> Gemini quota is used up for today.<br/>' +
    'Quota resets in <strong>' + resetIn + '</strong>. Your message will send automatically.<br/>' +
    '<small style="color:var(--muted)">Queued: "' + esc(text.slice(0, 80)) + (text.length > 80 ? 'â€¦' : '') + '"</small><br/>' +
    '<small style="color:var(--muted)">Tip: You can also upgrade Gemini at <a href="https://aistudio.google.com" target="_blank">aistudio.google.com</a>.</small>'
  );
}

async function flushQueue() {
  // Also restore any queue saved across page refreshes
  var saved = get('msg_queue', []);
  if (saved.length && !messageQueue.length) messageQueue = saved;
  set('msg_queue', []);
  if (!messageQueue.length) return;
  var queued = messageQueue.splice(0);
  addAI('âœ… <strong>Gemini quota restored!</strong> Sending ' + queued.length + ' queued message' + (queued.length > 1 ? 's' : '') + 'â€¦');
  for (var i = 0; i < queued.length; i++) {
    await sendMessageText(queued[i]);
    await new Promise(function(r){ setTimeout(r, 800); });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI CALL â€” Gemini only, with clear quota handling
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callAI(userMsg) {
  var provider = get('brain', 'gemini');
  var history  = get('conversation', []).slice(-20);

  // Already known to be rate-limited â€” don't even try
  if (isGeminiLimited()) {
    var e = new Error('quota'); e.isQuota = true; throw e;
  }

  var r = await fetch('/api/ai', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify({ provider: provider, systemPrompt: sysPrompt(), history: history, userMessage: userMsg }),
  });
  var data = await r.json();

  if (!r.ok) {
    var msg = data.error || 'HTTP ' + r.status;
    var low = msg.toLowerCase();
    var err = new Error(msg);

    if (r.status === 429 || low.includes('quota') || low.includes('exhausted') || low.includes('resource_exhausted')) {
      err.isQuota = true;
      throw err;
    }
    if (r.status === 401 || r.status === 403) {
      err.friendlyHTML = 'ğŸ”‘ <strong>API key rejected.</strong> Check your GEMINI_API_KEY in Vercel environment variables.';
      throw err;
    }
    err.friendlyHTML = 'âŒ <strong>Error:</strong> ' + esc(msg);
    throw err;
  }

  if (!data.response) throw new Error('Empty response from server.');
  return data.response;
}

async function githubAPI(payload) {
  const r = await fetch('/api/github', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify(payload),
  });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || 'GitHub error: HTTP ' + r.status);
  return data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GITHUB PREFETCH (runs before AI call for repo/commit queries)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REPO_RE   = /repo|repositor|github|my projects?|my sites?|what.*(have|own)|how many/i;
const COMMIT_RE = /commit|commit history|recent changes|what changed|last (push|update)/i;

async function prefetchGitHub(text) {
  try {
    if (REPO_RE.test(text)) {
      const data = await githubAPI({ action: 'listRepos' });
      if (!data.repos) return null;
      if (!data.repos.length) return 'LIVE GITHUB DATA: No repositories found in this account.';
      const lines = data.repos.map(function(r) {
        return 'â€¢ ' + r.name + (r.description ? ' â€” ' + r.description : '') + (r.language ? ' [' + r.language + ']' : '') + ' (updated: ' + (r.updatedAt ? r.updatedAt.slice(0,10) : '?') + ', ' + (r.private ? 'private' : 'public') + ')';
      }).join('\n');
      return 'LIVE GITHUB DATA (fetched ' + new Date().toISOString() + '):\n' + name + ' has ' + data.total + ' repo' + (data.total === 1 ? '' : 's') + ' on GitHub:\n' + lines;
    }
    if (COMMIT_RE.test(text)) {
      const repo = get('repo1', '');
      if (!repo) return null;
      const data = await githubAPI({ action: 'listCommits', repo: repo, limit: 8 });
      if (!data.commits || !data.commits.length) return null;
      const lines = data.commits.map(function(c) {
        return 'â€¢ [' + c.sha + '] ' + (c.date ? c.date.slice(0,10) : '') + ' â€” ' + c.message + ' (by ' + c.author + ')';
      }).join('\n');
      return 'LIVE GITHUB DATA â€” Recent commits for ' + repo + ':\n' + lines;
    }
  } catch (e) {
    console.warn('GitHub prefetch failed:', e.message);
    return 'Note: GitHub prefetch failed (' + e.message + '). Answer from memory only.';
  }
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEPLOY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function executeDeploy(action, msgEl) {
  const { repo, branch, commit_message, files } = action;
  const bubble = msgEl.querySelector('.bubble');
  let log = '';
  function appendLog(line, cls) {
    log += '<div class="' + (cls||'') + '">' + line + '</div>';
    bubble.querySelector('.deploy-log').innerHTML = log;
    scrollBot();
  }
  bubble.innerHTML = '<strong>ğŸš€ Deploying to GitHub...</strong><div class="deploy-progress"><div class="deploy-bar-wrap"><div class="deploy-bar" id="dBar"></div></div><div class="deploy-label" id="dLabel">Starting...</div></div><div class="deploy-log"></div>';
  for (var i = 0; i < files.length; i++) {
    var f = files[i];
    document.getElementById('dBar').style.width = Math.round((i / files.length) * 100) + '%';
    document.getElementById('dLabel').textContent = i + '/' + files.length + ' â€” ' + f.path;
    appendLog('â†’ ' + f.path, 'info');
    try {
      await githubAPI({ action: 'pushFile', repo: repo, branch: branch || 'main', path: f.path, content: f.content, commitMessage: commit_message || 'update: ' + f.path });
      appendLog('  âœ… pushed', 'ok');
    } catch (e) {
      appendLog('  âŒ ' + e.message, 'err');
    }
    await new Promise(function(r){ setTimeout(r, 280); });
  }
  document.getElementById('dBar').style.width = '100%';
  document.getElementById('dLabel').textContent = files.length + '/' + files.length + ' complete';
  appendLog('ğŸ‰ Done! Vercel will rebuild in ~60 seconds.', 'ok');
  scrollBot();
}

async function confirmDeploy(btn, actionStr) {
  btn.parentNode.innerHTML = '<em>Deployingâ€¦</em>';
  var action = JSON.parse(actionStr.replace(/&quot;/g, '"'));
  var el = addAI('<strong>ğŸš€ Startingâ€¦</strong>');
  try { await executeDeploy(action, el); }
  catch (e) { el.querySelector('.bubble').innerHTML = 'âŒ Deploy failed: ' + esc(e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESPONSE HANDLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleResponse(raw, msgEl) {
  // Extract special blocks
  var memMatches = [...raw.matchAll(/\[MEMORY\]([\s\S]*?)\[\/MEMORY\]/g)];
  var ghMatch    = raw.match(/\[ACTION:GITHUB\]([\s\S]*?)\[\/ACTION:GITHUB\]/);
  var depMatch   = raw.match(/\[ACTION:DEPLOY\]([\s\S]*?)\[\/ACTION:DEPLOY\]/);

  // Save memory facts
  memMatches.forEach(function(m) {
    var fact = m[1].trim();
    var facts = get('learnedFacts', []);
    if (!facts.includes(fact)) { facts.push(fact); set('learnedFacts', facts); }
  });

  // Clean display text
  var display = raw
    .replace(/\[MEMORY\][\s\S]*?\[\/MEMORY\]/g, '')
    .replace(/\[ACTION:GITHUB\][\s\S]*?\[\/ACTION:GITHUB\]/g, '')
    .replace(/\[ACTION:DEPLOY\][\s\S]*?\[\/ACTION:DEPLOY\]/g, '')
    .trim();

  if (display) msgEl.querySelector('.bubble').innerHTML = fmt(display);
  scrollBot();

  // Handle GitHub read action
  if (ghMatch) {
    var ghPayload;
    try { ghPayload = safeParseJSON(ghMatch[1]); }
    catch (e) { addAI('âš ï¸ GitHub action JSON was malformed. Please rephrase your request.'); return; }

    var fetchEl = addAI('<em>ğŸ” Fetching from GitHub (' + ghPayload.action + ')â€¦</em>');
    var ghResult;
    try {
      ghResult = await githubAPI(ghPayload);
      fetchEl.querySelector('.bubble').innerHTML = '<em>âœ… Got data â€” summarisingâ€¦</em>';
    } catch (e) {
      fetchEl.querySelector('.bubble').innerHTML = 'âŒ GitHub error: ' + esc(e.message);
      return;
    }

    var resultStr  = JSON.stringify(ghResult, null, 2);
    var followUp   = 'Here is the real live data from GitHub for my ' + ghPayload.action + ' request:\n\n' + resultStr + '\n\nPlease summarise this clearly and helpfully for me in plain language.';
    pushConvo('assistant', raw);
    pushConvo('user', followUp);
    showTyping();
    try {
      var summary = await callAI(followUp);
      hideTyping();
      var clean = summary.replace(/\[ACTION:GITHUB\][\s\S]*?\[\/ACTION:GITHUB\]/g,'').replace(/\[MEMORY\][\s\S]*?\[\/MEMORY\]/g,'').trim();
      fetchEl.querySelector('.bubble').innerHTML = fmt(clean);
      pushConvo('assistant', summary);
    } catch (e) {
      hideTyping();
      fetchEl.querySelector('.bubble').innerHTML = e.friendlyHTML || ('âŒ ' + esc(e.message));
    }
    scrollBot();
    return;
  }

  // Handle deploy action
  if (depMatch) {
    var action;
    try { action = safeParseJSON(depMatch[1]); }
    catch (e) { addAI('âš ï¸ Deploy action had malformed JSON. Please try again.'); return; }
    var cnt = (action.files && action.files.length) || 0;
    var safe = JSON.stringify(action).replace(/"/g, '&quot;');
    addAI('<strong>Ready to deploy ' + cnt + ' file(s) to <code>' + action.repo + '</code></strong><br/><br/>Shall I go ahead?<br/><button class="action-btn green" onclick="confirmDeploy(this,\'' + safe + '\')">âœ… Yes, deploy now</button><button class="action-btn" onclick="this.closest(\'.msg\').remove()">âŒ Cancel</button>');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN SEND â€” button always re-enabled in finally block
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessageText(text) {
  addUser(text);
  document.getElementById('statusDot').className    = 'status-dot thinking';
  document.getElementById('statusText').textContent  = 'Thinkingâ€¦';
  showTyping();
  try {
    var ghContext = await prefetchGitHub(text);
    var msgToSend = ghContext ? text + '\n\n---\n' + ghContext + '\n---\nUse the above live data to answer accurately.' : text;
    pushConvo('user', text);
    var response = await callAI(msgToSend);
    hideTyping();
    var el = addAI('');
    await handleResponse(response, el);
    pushConvo('assistant', response);
  } catch (e) {
    hideTyping();
    if (e.isQuota) {
      markGeminiLimited();
      queueMessage(text);
    } else {
      addAI(e.friendlyHTML || ('âŒ <strong>Error:</strong> ' + esc(e.message)));
    }
  }
}

async function sendMessage() {
  var inp  = document.getElementById('userInput');
  var text = inp.value.trim();
  if (!text) return;
  var btn = document.getElementById('sendBtn');
  btn.disabled = true;
  inp.value = ''; inp.style.height = 'auto';
  try {
    await sendMessageText(text);
  } finally {
    btn.disabled = false;
    updateStatus();
    inp.focus();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = function() {
  updateStatus();
  if (!get('setupDone')) setTimeout(openSetup, 600);
  // Restore rate limit countdown + queue if quota was hit before page refresh
  if (isGeminiLimited()) startCountdown();
};
</script>
</body>
</html>

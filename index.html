<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Fahad's Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
/* â”€â”€ TOKENS â”€â”€ */
:root {
  --bg:        #0a0a0b;
  --bg2:       #111113;
  --bg3:       #18181c;
  --bg4:       #202026;
  --border:    #2a2a32;
  --border2:   #353540;
  --text:      #e8e8f0;
  --text2:     #9090a8;
  --text3:     #5a5a70;
  --accent:    #7c6af7;
  --accent2:   #5c4ee0;
  --green:     #22c55e;
  --red:       #ef4444;
  --amber:     #f59e0b;
  --code-bg:   #0d0d10;
  --sidebar-w: 260px;
  --radius:    12px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;overflow:hidden;font-size:14px;-webkit-font-smoothing:antialiased;}

/* â”€â”€ LAYOUT â”€â”€ */
.app{display:flex;height:100dvh;position:relative;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;height:100%;
  transition:transform 0.25s ease;z-index:50;
}
.sidebar-top{padding:16px 12px 12px;border-bottom:1px solid var(--border);}
.new-chat-btn{
  width:100%;background:var(--bg4);border:1px solid var(--border2);
  border-radius:var(--radius);padding:10px 14px;
  color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;
  cursor:pointer;display:flex;align-items:center;gap:8px;
  transition:background 0.15s,border-color 0.15s;
}
.new-chat-btn:hover{background:var(--bg3);border-color:var(--accent);}
.new-chat-btn svg{width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2;}

.sidebar-section{padding:16px 12px 8px;font-size:10px;color:var(--text3);letter-spacing:0.12em;text-transform:uppercase;}
.chat-list{flex:1;overflow-y:auto;padding:0 8px;}
.chat-list::-webkit-scrollbar{width:3px;}
.chat-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px;}

.chat-item{
  padding:9px 10px;border-radius:9px;cursor:pointer;
  display:flex;align-items:center;gap:8px;
  color:var(--text2);font-size:12px;line-height:1.4;
  transition:background 0.12s,color 0.12s;
  position:relative;group:true;
}
.chat-item:hover{background:var(--bg3);color:var(--text);}
.chat-item.active{background:var(--bg4);color:var(--text);border:1px solid var(--border2);}
.chat-item-icon{font-size:13px;flex-shrink:0;}
.chat-item-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.chat-item-del{
  opacity:0;font-size:11px;color:var(--text3);background:none;border:none;
  cursor:pointer;padding:2px 4px;border-radius:4px;transition:opacity 0.15s,color 0.15s;
}
.chat-item:hover .chat-item-del{opacity:1;}
.chat-item-del:hover{color:var(--red);}

.sidebar-bottom{padding:12px;border-top:1px solid var(--border);}
.mode-toggle{
  display:flex;background:var(--bg);border:1px solid var(--border);
  border-radius:var(--radius);padding:3px;gap:3px;margin-bottom:10px;
}
.mode-btn{
  flex:1;padding:7px 8px;border:none;border-radius:9px;
  font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;
  color:var(--text2);background:transparent;transition:all 0.2s;text-align:center;
}
.mode-btn.active{background:var(--accent);color:white;font-weight:500;}
.mode-btn:not(.active):hover{background:var(--bg3);color:var(--text);}

.settings-btn{
  width:100%;background:transparent;border:1px solid var(--border);
  border-radius:var(--radius);padding:9px 12px;
  color:var(--text2);font-family:'JetBrains Mono',monospace;font-size:12px;
  cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.15s;
}
.settings-btn:hover{border-color:var(--border2);color:var(--text);background:var(--bg3);}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;min-width:0;position:relative;}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;border-bottom:1px solid var(--border);
  background:var(--bg);flex-shrink:0;backdrop-filter:blur(12px);
}
.topbar-left{display:flex;align-items:center;gap:10px;}
.sidebar-toggle{
  background:none;border:1px solid var(--border);border-radius:8px;
  width:32px;height:32px;color:var(--text2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:14px;
  transition:all 0.15s;
}
.sidebar-toggle:hover{border-color:var(--border2);color:var(--text);background:var(--bg3);}
.agent-title{font-family:'Inter',sans-serif;font-size:15px;font-weight:600;color:var(--text);}
.agent-subtitle{font-size:10px;color:var(--text3);letter-spacing:0.05em;}

.mode-badge{
  display:inline-flex;align-items:center;gap:5px;
  padding:4px 10px;border-radius:100px;font-size:10px;font-weight:500;
  letter-spacing:0.08em;text-transform:uppercase;
}
.mode-badge.strategic{background:rgba(124,106,247,0.15);color:var(--accent);border:1px solid rgba(124,106,247,0.3);}
.mode-badge.code{background:rgba(34,197,94,0.1);color:var(--green);border:1px solid rgba(34,197,94,0.25);}
.mode-badge .dot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:pulse 2s infinite;}

/* â”€â”€ MESSAGES â”€â”€ */
.messages{
  flex:1;overflow-y:auto;padding:24px 0;
  display:flex;flex-direction:column;
}
.messages::-webkit-scrollbar{width:4px;}
.messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

.msg-wrap{
  padding:18px 0;display:flex;gap:16px;
  width:100%;max-width:760px;margin:0 auto;
  padding-left:24px;padding-right:24px;
}
.msg-wrap.user{flex-direction:row-reverse;}
.msg-wrap + .msg-wrap.ai{border-top:none;}

.msg-avatar{
  width:32px;height:32px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:15px;
  margin-top:2px;
}
.msg-wrap.ai .msg-avatar{background:var(--accent2);}
.msg-wrap.user .msg-avatar{background:var(--bg4);border:1px solid var(--border2);}

/* AI messages: no bubble â€” just text, full width */
.bubble{
  flex:1;font-size:15px;line-height:1.85;word-break:break-word;
  color:var(--text);min-width:0;
}
.msg-wrap.user .bubble{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:18px 18px 4px 18px;
  padding:12px 18px;font-size:15px;
  max-width:80%;flex:0 1 auto;
}
.msg-wrap.ai .bubble{
  background:transparent;border:none;padding:0;
}
.bubble strong{color:var(--text);font-weight:600;}
.bubble em{color:var(--text2);}
.bubble a{color:var(--accent);text-decoration:none;}
.bubble a:hover{text-decoration:underline;}
.bubble p{margin:0 0 10px;} .bubble p:last-child{margin-bottom:0;}
.bubble code{
  background:var(--code-bg);border:1px solid var(--border);
  padding:2px 7px;border-radius:5px;font-family:'JetBrains Mono',monospace;
  font-size:13px;color:#a78bfa;
}
.bubble pre{
  background:var(--code-bg);border:1px solid var(--border);
  border-radius:10px;padding:16px;font-family:'JetBrains Mono',monospace;
  font-size:13px;overflow-x:auto;margin:12px 0;line-height:1.65;
  color:#c4b5fd;white-space:pre-wrap;word-break:break-word;
}
.bubble hr{border:none;border-top:1px solid var(--border);margin:12px 0;}
.bubble h1,.bubble h2,.bubble h3{
  font-family:'Inter',sans-serif;font-weight:600;
  color:var(--text);margin:16px 0 8px;line-height:1.3;
}
.bubble h1{font-size:18px;} .bubble h2{font-size:16px;} .bubble h3{font-size:15px;}
.bubble ul,.bubble ol{padding-left:22px;margin:8px 0;}
.bubble li{margin:4px 0;}

/* Status whisper â€” faint 1-liner shown while agent is working */
.whisper{
  width:100%;max-width:760px;margin:0 auto;
  padding:4px 24px 4px 72px;
  font-size:11.5px;color:var(--text3);
  font-style:italic;letter-spacing:0.01em;
  animation:whisperPulse 1.4s ease-in-out infinite;
  display:none;
}
.whisper.show{display:block;}
@keyframes whisperPulse{0%,100%{opacity:0.5;}50%{opacity:1;}}

/* Streaming cursor blink */
.cursor{
  display:inline-block;width:2px;height:1em;
  background:var(--text2);margin-left:1px;vertical-align:text-bottom;
  animation:cursorBlink 0.7s step-end infinite;
}
@keyframes cursorBlink{0%,100%{opacity:1;}50%{opacity:0;}}

/* Code mode entry banner */
.code-mode-banner{
  background:linear-gradient(135deg,rgba(34,197,94,0.08),rgba(34,197,94,0.03));
  border:1px solid rgba(34,197,94,0.2);border-radius:10px;
  padding:10px 14px;margin-bottom:8px;font-size:11px;color:var(--green);
  display:flex;align-items:center;gap:8px;
}

/* Action buttons */
.action-btn{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--accent);color:white;border:none;border-radius:8px;
  padding:8px 14px;font-family:'JetBrains Mono',monospace;font-size:11px;
  cursor:pointer;margin-top:10px;margin-right:8px;transition:opacity 0.15s;
}
.action-btn:hover{opacity:0.85;}
.action-btn.green{background:#16a34a;}
.action-btn.red{background:#dc2626;}

/* Typing */
.typing-wrap{
  padding:8px 24px;display:flex;gap:16px;
  max-width:760px;margin:0 auto;width:100%;align-items:center;
}
.typing-dots{
  display:flex;gap:5px;align-items:center;padding:4px 0;
}
.typing-dots span{
  width:5px;height:5px;background:var(--text3);border-radius:50%;
  animation:dot 1.2s infinite;
}
.typing-dots span:nth-child(2){animation-delay:0.2s;}
.typing-dots span:nth-child(3){animation-delay:0.4s;}
@keyframes dot{0%,60%,100%{transform:translateY(0);opacity:0.4;}30%{transform:translateY(-4px);opacity:1;}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}

/* Deploy progress */
.deploy-bar-wrap{background:var(--bg);border-radius:100px;height:4px;overflow:hidden;margin:8px 0 4px;}
.deploy-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:100px;transition:width 0.4s;width:0%;}
.deploy-label{font-size:10px;color:var(--text3);}
.deploy-log{font-size:11px;margin-top:8px;line-height:1.9;max-height:160px;overflow-y:auto;}
.deploy-log .ok{color:var(--green);}
.deploy-log .err{color:var(--red);}
.deploy-log .info{color:var(--accent);}

/* Welcome */
.welcome{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:40px 20px;text-align:center;max-width:600px;margin:0 auto;width:100%;
}
.welcome-logo{
  width:56px;height:56px;background:var(--accent2);border-radius:16px;
  display:flex;align-items:center;justify-content:center;font-size:26px;
  margin-bottom:20px;box-shadow:0 0 40px rgba(124,106,247,0.3);
}
.welcome h1{font-family:'Inter',sans-serif;font-size:24px;font-weight:600;margin-bottom:8px;color:var(--text);}
.welcome p{font-size:14px;color:var(--text2);line-height:1.8;margin-bottom:28px;max-width:400px;}
.suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
.suggestion{
  background:var(--bg2);border:1px solid var(--border);border-radius:20px;
  padding:8px 16px;font-size:11.5px;color:var(--text2);cursor:pointer;
  font-family:'Inter',sans-serif;font-size:13px;transition:all 0.15s;
}
.suggestion:hover{border-color:var(--accent);color:var(--accent);background:rgba(124,106,247,0.05);}

/* â”€â”€ INPUT AREA â”€â”€ */
.input-area{
  padding:14px 20px;padding-bottom:max(14px,env(safe-area-inset-bottom));
  border-top:1px solid var(--border);background:var(--bg);flex-shrink:0;
}
.input-box{
  max-width:800px;margin:0 auto;
  background:var(--bg2);border:1px solid var(--border2);border-radius:14px;
  display:flex;align-items:flex-end;gap:8px;padding:8px 8px 8px 16px;
  transition:border-color 0.2s;
}
.input-box:focus-within{border-color:var(--accent);}
#userInput{
  flex:1;background:transparent;border:none;color:var(--text);
  font-family:'Inter',sans-serif;font-size:15px;
  outline:none;resize:none;max-height:140px;line-height:1.6;padding:4px 0;
}
#userInput::placeholder{color:var(--text3);}
.send-btn{
  width:34px;height:34px;background:var(--accent);border:none;
  border-radius:9px;cursor:pointer;display:flex;align-items:center;
  justify-content:center;flex-shrink:0;transition:opacity 0.15s,transform 0.1s;color:white;
}
.send-btn:hover{opacity:0.85;}
.send-btn:active{transform:scale(0.93);}
.send-btn:disabled{opacity:0.25;cursor:not-allowed;transform:none;}
.send-btn svg{width:15px;height:15px;fill:currentColor;}

.status-bar{
  max-width:800px;margin:0 auto 8px;
  display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text3);
}
.status-dot{width:5px;height:5px;border-radius:50%;background:var(--text3);}
.status-dot.ready{background:var(--green);animation:pulse 2.5s infinite;}
.status-dot.thinking{background:var(--amber);animation:pulse 0.7s infinite;}

/* â”€â”€ SETTINGS OVERLAY â”€â”€ */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;
  display:none;align-items:center;justify-content:center;
  backdrop-filter:blur(4px);
}
.overlay.open{display:flex;}
.settings-panel{
  background:var(--bg2);border:1px solid var(--border);border-radius:18px;
  width:min(520px,92vw);max-height:88vh;overflow-y:auto;padding:28px;
}
.settings-panel::-webkit-scrollbar{width:3px;}
.settings-panel::-webkit-scrollbar-thumb{background:var(--border2);}
.settings-title{font-family:'Inter',sans-serif;font-size:20px;font-weight:700;margin-bottom:4px;}
.settings-sub{font-size:11px;color:var(--text3);margin-bottom:24px;line-height:1.6;}
.field-label{font-size:10px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:6px;display:block;}
.field-input{
  width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:9px;padding:11px 14px;font-family:'JetBrains Mono',monospace;
  font-size:12px;color:var(--text);outline:none;transition:border-color 0.2s;
  -webkit-appearance:none;
}
.field-input:focus{border-color:var(--accent);}
.field-input::placeholder{color:var(--text3);}
textarea.field-input{min-height:80px;resize:vertical;line-height:1.6;}
.settings-section{margin-bottom:20px;}

.secure-note{
  display:flex;align-items:center;gap:8px;
  background:rgba(34,197,94,0.07);border:1px solid rgba(34,197,94,0.2);
  border-radius:9px;padding:10px 14px;font-size:11px;color:var(--green);margin-bottom:20px;
}
.memory-box{
  background:var(--bg3);border:1px solid var(--border);border-radius:9px;
  padding:12px 14px;font-size:11px;color:var(--text2);line-height:1.8;
  min-height:60px;white-space:pre-wrap;word-break:break-word;
}
.btn-row{display:flex;gap:10px;margin-top:4px;}
.clear-btn{
  background:transparent;border:1px solid var(--border2);color:var(--text3);
  border-radius:8px;padding:7px 14px;font-family:'JetBrains Mono',monospace;
  font-size:11px;cursor:pointer;transition:all 0.15s;
}
.clear-btn:hover{border-color:var(--red);color:var(--red);}
.save-btn{
  flex:1;background:var(--accent);color:white;border:none;border-radius:9px;
  padding:13px;font-family:'Inter',sans-serif;font-size:15px;font-weight:600;
  cursor:pointer;transition:opacity 0.2s;margin-top:16px;
}
.save-btn:hover{opacity:0.88;}

/* Mobile sidebar overlay */
.sidebar-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:40;}
@media(max-width:700px){
  .sidebar{position:fixed;top:0;left:0;bottom:0;transform:translateX(-100%);z-index:50;}
  .sidebar.open{transform:translateX(0);}
  .sidebar-backdrop.show{display:block;}
}

/* Animations */
@keyframes msgIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.msg-wrap{animation:msgIn 0.2s ease-out;}

/* â”€â”€ LOGIN SCREEN â”€â”€ */
.login-screen {
  position: fixed; inset: 0; background: var(--bg);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000; padding: 20px;
}
.login-screen.hidden { display: none; }

.login-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 20px; padding: 40px 36px; width: min(420px, 100%);
  box-shadow: 0 24px 64px rgba(0,0,0,0.6);
  animation: loginIn 0.35s cubic-bezier(0.16,1,0.3,1);
}
@keyframes loginIn {
  from { opacity: 0; transform: translateY(20px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.login-logo {
  width: 52px; height: 52px; background: var(--accent2);
  border-radius: 15px; display: flex; align-items: center;
  justify-content: center; font-size: 24px; margin-bottom: 24px;
  box-shadow: 0 0 32px rgba(124,106,247,0.35);
}
.login-title { font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 700; margin-bottom: 6px; }
.login-sub   { font-size: 12px; color: var(--text3); margin-bottom: 28px; line-height: 1.6; }

.login-field { margin-bottom: 16px; }
.login-field label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 6px; }
.login-input {
  width: 100%; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 10px; padding: 13px 14px;
  font-family: 'Inter', sans-serif; font-size: 14px; color: var(--text);
  outline: none; transition: border-color 0.2s; -webkit-appearance: none;
}
.login-input:focus { border-color: var(--accent); }
.login-input::placeholder { color: var(--text3); }

.login-btn {
  width: 100%; background: var(--accent); color: white; border: none;
  border-radius: 10px; padding: 14px; margin-top: 8px;
  font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 600;
  cursor: pointer; transition: opacity 0.2s, transform 0.1s;
}
.login-btn:hover   { opacity: 0.88; }
.login-btn:active  { transform: scale(0.98); }
.login-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

.login-error {
  background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
  border-radius: 9px; padding: 10px 14px; font-size: 12px; color: #fca5a5;
  margin-bottom: 16px; display: none;
}
.login-error.show { display: block; }

.login-footer { text-align: center; margin-top: 20px; font-size: 10px; color: var(--text3); }
.login-footer a { color: var(--text3); text-decoration: none; }

</style>
</head>
<body>
<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-top">
      <button class="new-chat-btn" onclick="newChat()">
        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New chat
      </button>
    </div>

    <div class="sidebar-section">Recent</div>
    <div class="chat-list" id="chatList"></div>

    <div class="sidebar-bottom">
      <div class="mode-toggle" id="modeToggle">
        <button class="mode-btn active" id="btnStrategic" onclick="setMode('strategic')">âš¡ Strategic</button>
        <button class="mode-btn" id="btnCode" onclick="setMode('code')">{'</>'}  Code</button>
      </div>
      <button class="settings-btn" onclick="openSettings()">
        <span>âš™ï¸</span> Settings
      </button>
    </div>
  </div>

  <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeSidebar()"></div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
        <div>
          <div class="agent-title" id="agentTitle">Fahad's Agent</div>
          <div class="agent-subtitle" id="agentSubtitle">Personal AI Â· Eritage ENT Care</div>
        </div>
      </div>
      <div class="mode-badge strategic" id="modeBadge">
        <span class="dot"></span>
        <span id="modeLabel">Strategic Mode</span>
      </div>
    </div>

    <div class="messages" id="messages">
      <div class="welcome" id="welcomeScreen">
        <div class="welcome-logo">ğŸ¤–</div>
        <h1 id="welcomeTitle">Good to see you, Fahad</h1>
        <p>Your personal cognitive extension. I think, plan, build, and deploy â€” just tell me what you need.</p>
        <div class="suggestions">
          <div class="suggestion" onclick="quickSend('List all my GitHub repositories')">ğŸ“ List my repos</div>
          <div class="suggestion" onclick="quickSend('What strategies can grow my clinic patient base?')">ğŸ¥ Grow my clinic</div>
          <div class="suggestion" onclick="quickSend('Give me an SEO audit plan for eritageentcare.com')">ğŸ” SEO audit plan</div>
          <div class="suggestion" onclick="quickSend('What do you remember about me?')">ğŸ§  What you know</div>
        </div>
      </div>
    </div>

    <div class="whisper" id="whisper"></div>
  <div class="input-area">
      <div class="status-bar">
        <div class="status-dot ready" id="statusDot"></div>
        <span id="statusText">Ready</span>
      </div>
      <div class="input-box">
        <textarea id="userInput" rows="1" placeholder="Ask anything or give me a taskâ€¦" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- SETTINGS OVERLAY -->
  <div class="overlay" id="settingsOverlay">
    <div class="settings-panel">
      <div class="settings-title">Settings</div>
      <div class="settings-sub">Preferences are saved locally. API keys stay on the server.</div>
      <div class="secure-note">ğŸ”’ GEMINI_API_KEY Â· GITHUB_TOKEN â€” server-side only, never in browser</div>

      <div class="settings-section">
        <label class="field-label">Your Name</label>
        <input class="field-input" id="s_name" placeholder="e.g. Fahad"/>
      </div>
      <div class="settings-section">
        <label class="field-label">AI Brain</label>
        <select class="field-input" id="s_brain">
          <option value="gemini">Google Gemini 2.5 Flash (Free)</option>
          <option value="openai">OpenAI GPT-4o-mini (Paid)</option>
        </select>
      </div>
      <div class="settings-section">
        <label class="field-label" style="display:flex;align-items:center;justify-content:space-between;">
          Active GitHub Repo
          <span style="background:rgba(124,106,247,0.12);color:var(--accent);font-size:9px;padding:2px 8px;border-radius:20px;letter-spacing:0.06em;">AUTO-DETECTED</span>
        </label>
        <div id="activeRepoDisplay" style="
          background:var(--bg3);border:1px solid var(--border);border-radius:10px;
          padding:11px 14px;font-size:13px;color:var(--text2);
          display:flex;align-items:center;justify-content:space-between;gap:10px;
        ">
          <span id="activeRepoName" style="font-family:'JetBrains Mono',monospace;font-size:12px;">None detected yet</span>
          <button onclick="clearActiveRepo()" style="
            background:none;border:1px solid var(--border2);border-radius:6px;
            color:var(--text3);font-size:10px;padding:3px 9px;cursor:pointer;
            font-family:'Inter',sans-serif;white-space:nowrap;
          ">&#x2715; Clear</button>
        </div>
        <div style="font-size:10.5px;color:var(--text3);margin-top:6px;line-height:1.6;">
          Just mention a repo by name in conversation and the agent switches automatically.
          e.g. <em style="color:var(--text2)">"fix the bug in my agent repo"</em>
        </div>
      </div>
      <div class="settings-section">
        <label class="field-label">About You & Your Projects</label>
        <textarea class="field-input" id="s_about" placeholder="I'm a Clinical Otolaryngologist running Eritage ENT Care in Uganda..."></textarea>
      </div>
      <div class="settings-section">
        <label class="field-label">Preferences</label>
        <textarea class="field-input" id="s_prefs" placeholder="Be direct. No jargon. Explain before acting..."></textarea>
      </div>
      <div class="settings-section">
        <label class="field-label">Learned Facts (from conversation)</label>
        <div class="memory-box" id="memoryBox">Nothing saved yet.</div>
        <div class="btn-row">
          <button class="clear-btn" onclick="clearMemory()">&#x1F5D1; Clear facts</button>
          <button class="clear-btn" onclick="clearAllChats()">&#x1F5D1; Clear all chats</button>
        </div>
      </div>
      <div class="settings-section">
        <label class="field-label" style="display:flex;align-items:center;gap:6px;">
          Adaptive Profile
          <span style="background:rgba(124,106,247,0.15);color:var(--accent);font-size:9px;padding:2px 7px;border-radius:20px;letter-spacing:0.05em;">LIVE Â· UPDATES DAILY</span>
        </label>
        <div class="memory-box" id="profileBox" style="font-size:11px;line-height:1.8;">Not enough interactions yet. Builds over time.</div>
      </div>
      <div class="settings-section">
        <button class="clear-btn" style="width:100%;border-color:rgba(124,106,247,0.4);color:var(--accent);" onclick="closeSettings();doLogout()">&#x1F512; Sign out</button>
      </div>
      <button class="save-btn" onclick="saveSettings()">Save & close â†’</button>
    </div>
  </div>




  <!-- LOGIN SCREEN (shown when not authenticated) -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-logo">&#x1F916;</div>
      <div class="login-title">Agent Access</div>
      <div class="login-sub">Private workspace. Authorized personnel only.</div>
      <div class="login-error" id="loginError"></div>
      <div class="login-field">
        <label>Username</label>
        <input class="login-input" type="text" id="loginUser"
          placeholder="Enter username" autocomplete="username"
          onkeydown="loginKey(event)" />
      </div>
      <div class="login-field">
        <label>Password</label>
        <input class="login-input" type="password" id="loginPass"
          placeholder="Enter password" autocomplete="current-password"
          onkeydown="loginKey(event)" />
      </div>
      <button class="login-btn" id="loginBtn" onclick="doLogin()">Sign in</button>
      <div class="login-footer">Eritage ENT Care &middot; Private Agent</div>
    </div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION TOKEN â€” stored in sessionStorage (cleared on tab close)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSessionToken()   { return sessionStorage.getItem('agent_tok') || ''; }
function setSessionToken(t)  { sessionStorage.setItem('agent_tok', t); }
function clearSessionToken() { sessionStorage.removeItem('agent_tok'); }
function isLoggedIn()        { return !!getSessionToken(); }

function showLoginScreen() {
  document.getElementById('loginScreen').classList.remove('hidden');
  var u = document.getElementById('loginUser');
  var p = document.getElementById('loginPass');
  if (u) u.value = '';
  if (p) p.value = '';
  var e = document.getElementById('loginError');
  if (e) { e.classList.remove('show'); e.textContent = ''; }
  var b = document.getElementById('loginBtn');
  if (b) { b.disabled = false; b.textContent = 'Sign in'; }
}

function hideLoginScreen() {
  document.getElementById('loginScreen').classList.add('hidden');
}

function handleSessionExpiry() {
  clearSessionToken();
  showLoginScreen();
  var e = document.getElementById('loginError');
  if (e) { e.textContent = 'Session expired. Please sign in again.'; e.classList.add('show'); }
}

function loginKey(e) { if (e.key === 'Enter') doLogin(); }

async function doLogin() {
  var user  = document.getElementById('loginUser').value.trim();
  var pass  = document.getElementById('loginPass').value;
  var errEl = document.getElementById('loginError');
  var btn   = document.getElementById('loginBtn');

  errEl.classList.remove('show');
  if (!user || !pass) {
    errEl.textContent = 'Please enter both username and password.';
    errEl.classList.add('show');
    return;
  }
  btn.disabled = true;
  btn.textContent = 'Signing in...';
  try {
    var r    = await fetch('/api/auth', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: user, password: pass }) });
    var text = await r.text();
    var data;
    try { data = text ? JSON.parse(text) : {}; } catch(ex) { data = {}; }
    if (r.ok && data.token) {
      setSessionToken(data.token);
      hideLoginScreen();
      initApp();
    } else {
      errEl.textContent = data.error || 'Login failed. Check your credentials.';
      errEl.classList.add('show');
      btn.disabled = false;
      btn.textContent = 'Sign in';
    }
  } catch(ex) {
    errEl.textContent = 'Network error. Is the server running?';
    errEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = 'Sign in';
  }
}

function doLogout() {
  clearSessionToken();
  showLoginScreen();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var MEM_KEY = 'aiagent_v4';
function mem()       { try { return JSON.parse(localStorage.getItem(MEM_KEY) || '{}'); } catch(e) { return {}; } }
function saveMem(d)  { localStorage.setItem(MEM_KEY, JSON.stringify(d)); }
function get(k, def) { var v = mem()[k]; return (v !== undefined && v !== null) ? v : (def !== undefined ? def : null); }
function set(k, v)   { var m = mem(); m[k] = v; saveMem(m); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN ESTIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function estimateTokens(str) { return Math.ceil(((str) || '').length / 4); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONVERSATION HISTORY â€” with compact summarisation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var HISTORY_TOKEN_BUDGET = 3000;
var SUMMARY_KEEP_RECENT  = 6;

function pushConvo(role, content) {
  var h = get('conversation', []);
  var stored = content.length > 4000 ? content.slice(0, 4000) + '...[truncated]' : content;
  h.push({ role: role, content: stored, time: Date.now() });
  if (h.length > 40) h.splice(0, h.length - 40);
  set('conversation', h);
}

function getCompactHistory() {
  var full   = get('conversation', []);
  if (!full.length) return [];
  var recent = full.slice(-SUMMARY_KEEP_RECENT);
  var older  = full.slice(0, -SUMMARY_KEEP_RECENT);
  var recentTokens = recent.reduce(function(t, m) { return t + estimateTokens(m.content); }, 0);
  if (recentTokens >= HISTORY_TOKEN_BUDGET || !older.length) return recent;
  var remaining = HISTORY_TOKEN_BUDGET - recentTokens;
  var parts = [], used = 0;
  for (var i = older.length - 1; i >= 0; i--) {
    var line = (older[i].role === 'user' ? 'U' : 'A') + ': ' + older[i].content.slice(0, 100).split('\n').join(' ');
    var t    = estimateTokens(line);
    if (used + t > remaining) break;
    parts.unshift(line);
    used += t;
  }
  if (!parts.length) return recent;
  return [{ role: 'user', content: '[PRIOR CONTEXT] ' + parts.join(' | ') }].concat(recent);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADAPTIVE LEARNING â€” Vercel KV via /api/learn
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _adaptiveProfile  = null;   // cached profile from KV
var _lastLearnCheck   = 0;      // timestamp of last learn run
var _pendingFeedback  = null;   // { userMsg, aiReply } waiting for next user turn to score

// Fetch adaptive profile from KV (once per session)
async function fetchAdaptiveProfile() {
  if (_adaptiveProfile) return _adaptiveProfile;
  try {
    var r = await fetch('/api/learn', { method: 'GET', headers: { 'X-Agent-Token': getSessionToken() } });
    if (!r.ok) return null;
    var data = await r.json();
    _adaptiveProfile = data.profile || null;
    _lastLearnCheck  = data.lastLearn || 0;
    return _adaptiveProfile;
  } catch(e) {
    console.warn('[learn] fetch profile failed:', e.message);
    return null;
  }
}

// Log one interaction exchange to KV (fire-and-forget)
function logInteraction(userMsg, aiReply, feedback) {
  fetch('/api/learn', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json', 'X-Agent-Token': getSessionToken() },
    body:    JSON.stringify({ action: 'log', userMsg: userMsg, aiReply: aiReply, feedback: feedback || 0 }),
  }).catch(function(e) { console.warn('[learn] log failed:', e.message); });
}

// Run analysis daily + weekly digest on Mondays (both fire-and-forget)
function maybeRunDailyAnalysis() {
  var now     = Date.now();
  var dayMs   = 24 * 60 * 60 * 1000;
  var lastRun = get('lastLearnRun', 0);
  if (now - lastRun < dayMs) return; // already ran today
  set('lastLearnRun', now);

  // Daily analysis
  fetch('/api/learn', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json', 'X-Agent-Token': getSessionToken() },
    body:    JSON.stringify({ action: 'analyse' }),
  }).then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.profile) {
        _adaptiveProfile = data.profile;
        console.log('[learn] daily analysis done. Interactions:', data.interactionCount);
      }
    })
    .catch(function(e) { console.warn('[learn] analysis failed:', e.message); });

  // Weekly digest â€” only on Mondays (day 1) or if never generated
  var today        = new Date().getDay(); // 0=Sun, 1=Mon
  var lastDigest   = get('lastWeeklyDigest', 0);
  var weekMs       = 7 * dayMs;
  var isMonday     = today === 1;
  var neverDone    = lastDigest === 0;
  var overdue      = (now - lastDigest) > weekMs;

  if (isMonday || neverDone || overdue) {
    set('lastWeeklyDigest', now);
    fetch('/api/learn', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json', 'X-Agent-Token': getSessionToken() },
      body:    JSON.stringify({ action: 'digest' }),
    }).then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.digest && data.digest.length > 50) {
          // Store digest for display and inject into next session
          set('weeklyDigest', data.digest);
          set('weeklyDigestDate', new Date().toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'short' }));
          console.log('[learn] weekly digest generated');
          // Show digest in chat if this is Monday morning
          if (isMonday) showWeeklyDigestInChat(data.digest);
        }
      })
      .catch(function(e) { console.warn('[learn] digest failed:', e.message); });
  }
}

// Show weekly digest as the first message on Monday
function showWeeklyDigestInChat(digest) {
  var msgs = document.getElementById('messages');
  // Only show if chat is currently empty (fresh session)
  var existing = msgs.querySelectorAll('.msg-wrap');
  if (existing.length > 0) return;
  var w = document.getElementById('welcomeScreen');
  if (w) w.remove();
  var d = document.createElement('div');
  d.className = 'msg-wrap ai';
  d.style.animation = 'none';
  d.innerHTML = '<div class="msg-avatar">&#x1F916;</div>'
    + '<div class="bubble">'
    + '<div style="font-size:11px;color:var(--text3);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.08em;">&#x1F4C6; Weekly digest â€” ' + (get('weeklyDigestDate','') || 'this week') + '</div>'
    + fmt(digest)
    + '</div>';
  msgs.appendChild(d);
  scrollBot();
}

// Score the previous AI reply based on the user's next message (implicit feedback)
function scoreImplicitFeedback(userMsg) {
  if (!_pendingFeedback) return;
  var pos = /\b(perfect|exactly|great|brilliant|yes|correct|love it|spot on|awesome|do it|go ahead|confirmed|proceed|thanks|thank you)\b/i.test(userMsg);
  var neg = /\b(no|wrong|not what i|that.s not|incorrect|stop|don.t|redo|again|rephrase|too long|too short|not helpful|useless|fix it)\b/i.test(userMsg);
  var score = (pos && !neg) ? 1 : (neg && !pos) ? -1 : 0;
  logInteraction(_pendingFeedback.userMsg, _pendingFeedback.aiReply, score);
  _pendingFeedback = null;
}

// Build the adaptive context block injected into sysPrompt
function buildAdaptiveContext(profile) {
  if (!profile) return '';
  var parts = [];

  // Style preferences
  if (profile.style) {
    if (profile.style.prefersBrief === true)  parts.push('Prefers concise replies (under 120 words).');
    if (profile.style.prefersBrief === false) parts.push('Engages well with detailed responses.');
    if (profile.style.prefersBullets === false) parts.push('Dislikes bullet points â€” use prose.');
    if (profile.style.prefersBullets === true)  parts.push('Responds well to bullet-point structure.');
  }

  // Recurring topics
  if (profile.recurringTopics && profile.recurringTopics.length) {
    var topics = profile.recurringTopics.slice(0, 3).map(function(t) { return t.topic.replace(/_/g, ' '); }).join(', ');
    parts.push('Most discussed topics lately: ' + topics + '.');
  }

  // Sentiment trend
  if (typeof profile.recentSentiment === 'number') {
    if (profile.recentSentiment > 0.4)  parts.push('Strong positive feedback recently â€” keep this style.');
    if (profile.recentSentiment < -0.2) parts.push('Some friction detected â€” be more direct and concise.');
  }

  // Custom observations
  if (profile.observations && profile.observations.length) {
    profile.observations.forEach(function(o) { parts.push(o); });
  }

  if (!parts.length) return '';
  return 'ADAPTIVE PROFILE: ' + parts.join(' ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT SESSIONS (sidebar history)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSessions()          { return get('sessions', []); }
function getCurrentSessionId()  { return get('currentSession', null); }

function saveSession(id, title, messages) {
  var sessions = getSessions();
  var idx      = sessions.findIndex(function(s) { return s.id === id; });
  var obj      = { id: id, title: title, messages: messages, updatedAt: Date.now() };
  if (idx >= 0) sessions[idx] = obj; else sessions.unshift(obj);
  if (sessions.length > 40) sessions.splice(40);
  set('sessions', sessions);
}

function loadSession(id) {
  return getSessions().find(function(s) { return s.id === id; }) || null;
}

function deleteSession(id) {
  var sessions = getSessions().filter(function(s) { return s.id !== id; });
  set('sessions', sessions);
  if (getCurrentSessionId() === id) {
    set('currentSession', null);
    set('conversation', []);
    renderMessages([]);
    showWelcome();
  }
  renderChatList();
}

function newChat() {
  var id = 'chat_' + Date.now();
  set('currentSession', id);
  set('conversation', []);
  renderMessages([]);
  showWelcome();
  renderChatList();
  closeSidebar();
  document.getElementById('userInput').focus();
}

function switchToSession(id) {
  var session = loadSession(id);
  if (!session) return;
  set('currentSession', id);
  set('conversation', session.messages || []);
  renderMessages(session.messages || []);
  renderChatList();
  closeSidebar();
}

function renderChatList() {
  var list      = document.getElementById('chatList');
  var sessions  = getSessions();
  var currentId = getCurrentSessionId();
  if (!sessions.length) {
    list.innerHTML = '<div style="padding:12px 10px;font-size:11px;color:var(--text3)">No chats yet</div>';
    return;
  }
  list.innerHTML = sessions.map(function(s) {
    var active = s.id === currentId ? ' active' : '';
    var title  = esc(s.title || 'New chat');
    return '<div class="chat-item' + active + '" onclick="switchToSession(\'' + s.id + '\')">'
      + '<span class="chat-item-icon">&#x1F4AC;</span>'
      + '<span class="chat-item-title">' + title + '</span>'
      + '<button class="chat-item-del" onclick="event.stopPropagation();deleteSession(\'' + s.id + '\')" title="Delete">&#x2715;</button>'
      + '</div>';
  }).join('');
}

function saveCurrentMessages() {
  var id   = getCurrentSessionId();
  if (!id) return;
  var conv = get('conversation', []);
  if (!conv.length) return;
  var firstUser = conv.find(function(m) { return m.role === 'user'; });
  var title     = firstUser ? firstUser.content.slice(0, 45) + (firstUser.content.length > 45 ? '...' : '') : 'New chat';
  saveSession(id, title, conv);
  renderChatList();
}

function renderMessages(messages) {
  var container = document.getElementById('messages');
  container.innerHTML = '';
  if (!messages || !messages.length) { showWelcome(); return; }
  messages.forEach(function(m) {
    if (m.role === 'user')      _addUser(m.content, false);
    else if (m.role === 'assistant') _addAI(m.content, false);
  });
  scrollBot();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var currentMode = 'strategic';

function setMode(mode) {
  currentMode = mode;
  set('mode', mode);
  document.getElementById('btnStrategic').classList.toggle('active', mode === 'strategic');
  document.getElementById('btnCode').classList.toggle('active', mode === 'code');
  var badge = document.getElementById('modeBadge');
  var label = document.getElementById('modeLabel');
  if (mode === 'code') { badge.className = 'mode-badge code'; label.textContent = 'Code Mode'; }
  else                 { badge.className = 'mode-badge strategic'; label.textContent = 'Strategic Mode'; }
}

function detectMode(text) {
  var codeSignals = /\b(code|github|repo|deploy|push|commit|file|function|bug|refactor|html|css|js|javascript|api|edit|update|fix|build|implement|create.*file|write.*code|show.*code)\b/i;
  if (codeSignals.test(text) && currentMode !== 'code')       { setMode('code');      return true; }
  if (!codeSignals.test(text) && currentMode !== 'strategic') { setMode('strategic'); }
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings() {
  document.getElementById('s_name').value       = get('userName', '');
  document.getElementById('s_brain').value      = get('brain', 'gemini');
  // Show current active repo (auto-detected)
  var activeRepoEl = document.getElementById('activeRepoName');
  if (activeRepoEl) {
    var r1 = get('repo1', '');
    activeRepoEl.textContent = r1 || 'None detected yet';
    activeRepoEl.style.color = r1 ? 'var(--text)' : 'var(--text3)';
  }
  document.getElementById('s_about').value      = get('about', '');
  document.getElementById('s_prefs').value      = get('prefs', '');
  var facts = get('learnedFacts', []);
  document.getElementById('memoryBox').textContent = facts.length ? facts.join('\n') : 'Nothing saved yet.';

  // Show adaptive profile in settings
  var profBox = document.getElementById('profileBox');
  if (profBox) {
    if (_adaptiveProfile) {
      var lines = [];
      if (_adaptiveProfile.totalInteractions)
        lines.push('Conversations tracked: ' + _adaptiveProfile.totalInteractions);
      if (_adaptiveProfile.style && _adaptiveProfile.style.avgReplyWordCount)
        lines.push('Your preferred reply length: ~' + _adaptiveProfile.style.avgReplyWordCount + ' words');
      if (_adaptiveProfile.recurringTopics && _adaptiveProfile.recurringTopics.length)
        lines.push('Top topics: ' + _adaptiveProfile.recurringTopics.slice(0,4).map(function(t){return t.topic.replace(/_/g,' ');}).join(', '));
      if (_adaptiveProfile.observations && _adaptiveProfile.observations.length)
        _adaptiveProfile.observations.forEach(function(o){ lines.push(o); });
      var digest = get('weeklyDigest','');
      if (digest) lines.push('\nâ€” Last weekly digest â€”\n' + digest.slice(0,300) + (digest.length > 300 ? '...' : ''));
      profBox.textContent = lines.length ? lines.join('\n') : 'Not enough interactions yet. Builds over time.';
    } else {
      profBox.textContent = 'Not enough interactions yet. Builds over time.';
    }
  }
  document.getElementById('settingsOverlay').classList.add('open');
}

function closeSettings() { document.getElementById('settingsOverlay').classList.remove('open'); }

function saveSettings() {
  set('userName',  document.getElementById('s_name').value.trim());
  set('brain',     document.getElementById('s_brain').value);
  // repo1 / repo1name are managed automatically by auto-detect â€” not saved from settings
  set('about',     document.getElementById('s_about').value.trim());
  set('prefs',     document.getElementById('s_prefs').value.trim());
  set('setupDone', true);
  closeSettings();
  updateStatus();
  var n = get('userName', '');
  addAI('Settings saved' + (n ? ', ' + n : '') + '. What would you like to work on?');
}

function clearMemory() {
  if (!confirm('Clear all agent memory?')) return;
  set('learnedFacts', []);
  addAI('Memory cleared.');
  openSettings();
}

function clearAllChats() {
  if (!confirm('Delete all chat history?')) return;
  set('sessions', []);
  set('conversation', []);
  set('currentSession', null);
  renderChatList();
  renderMessages([]);
  showWelcome();
  closeSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarBackdrop').classList.toggle('show');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarBackdrop').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearActiveRepo() {
  set('repo1', '');
  set('repo1name', '');
  _repoList = null; // force fresh fetch next time
  Object.keys(_ghCache).forEach(function(k) { delete _ghCache[k]; });
  var el = document.getElementById('activeRepoName');
  if (el) { el.textContent = 'None detected yet'; el.style.color = 'var(--text3)'; }
  updateStatus();
  addAI('Active repo cleared. Just mention a repo by name in conversation and I will switch to it automatically.');
  closeSettings();
}

function updateStatus() {
  var n  = get('userName', '');
  var rn = get('repo1name', '');
  var activeRepo = get('repo1name', '') || (get('repo1','').split('/')[1] || '');
  document.getElementById('statusDot').className    = 'status-dot ready';
  document.getElementById('statusText').textContent = 'Ready' + (activeRepo ? ' Â· ' + activeRepo : '') + (n ? ' Â· ' + n : '');
  if (n) {
    document.getElementById('agentTitle').textContent   = n + "'s Agent";
    document.getElementById('welcomeTitle').textContent = 'Good to see you, ' + n;
  }
  if (rn) document.getElementById('agentSubtitle').textContent = rn + ' Â· Eritage ENT Care';
}

function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 140) + 'px'; }
function handleKey(e)   { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
function quickSend(t)   { document.getElementById('userInput').value = t; sendMessage(); }
function scrollBot()    { var m = document.getElementById('messages'); setTimeout(function() { m.scrollTop = m.scrollHeight; }, 60); }

function showWelcome() {
  var msgs = document.getElementById('messages');
  if (document.getElementById('welcomeScreen')) return;
  var n = get('userName', 'Fahad');
  var w = document.createElement('div');
  w.className = 'welcome'; w.id = 'welcomeScreen';
  w.innerHTML = '<div class="welcome-logo">&#x1F916;</div>'
    + '<h1 id="welcomeTitle">Good to see you, ' + esc(n) + '</h1>'
    + '<p>Your personal cognitive extension. I think, plan, build, and deploy.</p>'
    + '<div class="suggestions">'
    + '<div class="suggestion" onclick="quickSend(\'List all my GitHub repositories\')">&#x1F4C1; List my repos</div>'
    + '<div class="suggestion" onclick="quickSend(\'What strategies can grow my clinic patient base?\')">&#x1F3E5; Grow my clinic</div>'
    + '<div class="suggestion" onclick="quickSend(\'Give me an SEO audit plan for eritageentcare.com\')">&#x1F50D; SEO audit plan</div>'
    + '<div class="suggestion" onclick="quickSend(\'What have you learned about how I like to work?\')">&#x1F9E0; What you\'ve learned</div>'
    + '</div>';
  msgs.appendChild(w);
}

function esc(t) {
  return String(t).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function fmt(text) {
  if (!text) return '';
  text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, function(_, lang, code) {
    return '<pre><code>' + code.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>';
  });
  text = text.replace(/`([^`\n]+)`/g, '<code>$1</code>');
  text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
  text = text.replace(/^### (.+)$/gm, '<strong style="font-size:13px;color:var(--accent)">$1</strong>');
  text = text.replace(/^## (.+)$/gm,  '<strong style="font-size:14px">$1</strong>');
  text = text.replace(/^---$/gm, '<hr/>');
  text = text.replace(/\n/g, '<br/>');
  return text;
}

function safeParseJSON(str) {
  var c = String(str).trim()
    .replace(/^```json\s*/i, '').replace(/```\s*$/, '')
    .replace(/^`+|`+$/g, '').trim();
  return JSON.parse(c);
}

function _addUser(text, animate) {
  var w = document.getElementById('welcomeScreen'); if (w) w.remove();
  var msgs = document.getElementById('messages');
  var d = document.createElement('div');
  d.className = 'msg-wrap user';
  if (!animate) d.style.animation = 'none';
  d.innerHTML = '<div class="msg-avatar">&#x1F464;</div><div class="bubble">' + esc(text) + '</div>';
  msgs.appendChild(d); scrollBot();
}
function addUser(text) { _addUser(text, true); }

function _addAI(html, animate) {
  var msgs = document.getElementById('messages');
  var d = document.createElement('div');
  d.className = 'msg-wrap ai';
  if (!animate) d.style.animation = 'none';
  d.innerHTML = '<div class="msg-avatar">&#x1F916;</div><div class="bubble">' + html + '</div>';
  msgs.appendChild(d); scrollBot(); return d;
}
function addAI(html) { return _addAI(html, true); }

function showTyping() {
  var msgs = document.getElementById('messages');
  var d    = document.createElement('div');
  d.className = 'typing-wrap'; d.id = 'typing';
  d.innerHTML = '<div class="msg-avatar" style="width:30px;height:30px;background:var(--accent2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:14px;margin-top:2px;">&#x1F916;</div>'
    + '<div class="typing-dots"><span></span><span></span><span></span></div>';
  msgs.appendChild(d); scrollBot();
}
function hideTyping() { var t = document.getElementById('typing'); if (t) t.remove(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYSTEM PROMPT â€” adaptive, lean, dual-mode
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sysPrompt() {
  var name    = get('userName', 'Fahad');
  var repo1   = get('repo1', '');
  var about   = get('about', '');
  var prefs   = get('prefs', '');
  var facts   = get('learnedFacts', []);
  var mode    = currentMode;
  var now     = new Date();
  var dateStr = now.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' });

  var aboutLine = (about && about.length > 5) ? 'About: ' + about : 'ENT surgeon, Uganda. Non-developer. Plain language.';
  var prefsLine = (prefs && prefs.length > 5) ? 'Prefs: ' + prefs : 'Direct, brief, no jargon.';
  var factLine  = facts.length ? ' Known: ' + facts.slice(-10).map(function(f) { return f.slice(0, 80); }).join('; ') : '';

  // Inject adaptive profile if available
  var adaptiveCtx = _adaptiveProfile ? buildAdaptiveContext(_adaptiveProfile) : '';

  var base = 'Agent for ' + name + ' (' + dateStr + '). Active repo: ' + (repo1 || 'none â€” will auto-detect from conversation') + '. '
    + aboutLine + ' ' + prefsLine + factLine
    + (adaptiveCtx ? ' ' + adaptiveCtx : '');

  var strategicInstr = 'STRATEGIC MODE: Senior strategist+technologist. Think deeply, surface insights unprompted, concrete actionable advice. Warm, witty. Say "Switching to Code Mode" when appropriate.';

  var codeInstr = 'CODE MODE: 1) Start "Code Mode â€” [what]" 2) Explain before code 3) Full file only 4) No action without yes/confirmed 5) Never assume structure 6) Never hallucinate paths.'
    + ' [ACTION:GITHUB]{"action":"listRepos"}[/ACTION:GITHUB]'
    + ' [ACTION:GITHUB]{"action":"getFile","repo":"owner/repo","path":"file"}[/ACTION:GITHUB]'
    + ' [ACTION:DEPLOY]{"repo":"...","branch":"main","commit_message":"...","files":[{"path":"...","content":"..."}]}[/ACTION:DEPLOY]'
    + ' Never push without explicit yes.';

  var memRule = ' Store facts: [MEMORY]fact[/MEMORY]';

  return base + '\n' + (mode === 'code' ? codeInstr : strategicInstr) + memRule;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATE LIMIT + COUNTDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var geminiResetAt     = 0;
var countdownInterval = null;
var messageQueue      = [];

function nextMidnightPacific() {
  var offset  = 8 * 60 * 60 * 1000;
  var pacific = new Date(Date.now() - offset);
  pacific.setHours(24, 0, 0, 0);
  return pacific.getTime() + offset;
}
function markGeminiLimited() { geminiResetAt = nextMidnightPacific(); set('gemini_reset_at', geminiResetAt); startCountdown(); }
function isGeminiLimited()   { if (!geminiResetAt) geminiResetAt = get('gemini_reset_at', 0); return geminiResetAt > Date.now(); }
function clearGeminiLimit()  { geminiResetAt = 0; set('gemini_reset_at', 0); }

function formatCountdown(ms) {
  if (ms <= 0) return '0s';
  var s = Math.floor(ms / 1000), h = Math.floor(s / 3600); s -= h * 3600;
  var m = Math.floor(s / 60); s -= m * 60;
  if (h > 0) return h + 'h ' + m + 'm';
  if (m > 0) return m + 'm ' + s + 's';
  return s + 's';
}

function startCountdown() {
  if (countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(function() {
    if (!isGeminiLimited()) {
      clearInterval(countdownInterval); countdownInterval = null;
      clearGeminiLimit(); updateStatus(); flushQueue(); return;
    }
    document.getElementById('statusDot').className    = 'status-dot';
    document.getElementById('statusText').textContent = 'Quota resets in ' + formatCountdown(geminiResetAt - Date.now());
  }, 1000);
}

function queueMessage(text) {
  messageQueue.push(text);
  set('msg_queue', messageQueue);
  addAI('<strong>Message queued.</strong> Gemini quota is up for today â€” resets in <strong>' + formatCountdown(geminiResetAt - Date.now()) + '</strong>. Will auto-send when quota refreshes.');
}

async function flushQueue() {
  var saved = get('msg_queue', []);
  if (saved.length && !messageQueue.length) messageQueue = saved;
  set('msg_queue', []);
  if (!messageQueue.length) return;
  var queued = messageQueue.splice(0);
  addAI('<strong>Quota restored!</strong> Sending ' + queued.length + ' queued message' + (queued.length > 1 ? 's' : '') + '...');
  for (var i = 0; i < queued.length; i++) {
    await sendMessageText(queued[i]);
    await new Promise(function(r) { setTimeout(r, 800); });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REASONING GATE â€” skip LLM for trivial inputs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function reasoningGate(text) {
  var t = text.trim().toLowerCase();
  if (/^(hi|hello|hey|halo|hiya|yo)[!.\s]*$/.test(t))
    return 'Hey ' + (get('userName', 'Fahad') || 'there') + '! What are we working on today?';
  if (/^(thanks|thank you|thx|cheers)[!.\s]*$/.test(t))
    return 'Anytime! What is next?';
  if (/^(ok|okay|got it|noted|sure|alright|sounds good)[!.\s]*$/.test(t))
    return 'Got it. What would you like to do next?';
  if (/^(what is |what.s )?(today.?s )?(date|time|day)\??$/.test(t)) {
    var n = new Date();
    return n.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
      + ' at ' + n.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  }
  if (/^what (mode|modes?)/.test(t))
    return currentMode === 'code' ? 'Code Mode â€” strict execution.' : 'Strategic Mode â€” planning and thinking.';
  // "what do you know about me" â€” fetch readable profile summary from /api/learn
  if (/what.*(know|learned|learn|remember|know about|figured out|noticed|observed).*(me|my|about me|about you)/i.test(t)
      || /what.*my.*profile/i.test(t)
      || /tell me.*about (myself|me|my habits|my style)/i.test(t)
      || /show.*my.*profile/i.test(t)) {
    fetchAndShowProfileSummary();
    return '__ASYNC__'; // signal that we handled it asynchronously
  }
  // "show weekly digest" or "what did we do this week"
  if (/weekly digest|this week.*(summary|recap|review)|what.*we.*work.*this week|what.*i.*work.*this week/i.test(t)) {
    fetchAndShowDigest();
    return '__ASYNC__';
  }
  return null;
}

// Fetch plain-language profile summary and display in chat
async function fetchAndShowProfileSummary() {
  var el = addAI('');
  var bubble = el.querySelector('.bubble');
  showWhisper('Reflecting on our conversations...');
  try {
    var r = await fetch('/api/learn?action=summary', {
      headers: { 'X-Agent-Token': getSessionToken() }
    });
    var data = await r.json();
    hideWhisper();
    if (data.summary) {
      bubble.innerHTML = fmt(data.summary);
    } else {
      bubble.innerHTML = 'I have not gathered enough data yet. Keep chatting and I will build a picture of how you like to work.';
    }
  } catch(e) {
    hideWhisper();
    bubble.innerHTML = 'Could not retrieve profile summary right now.';
  }
  scrollBot();
}

// Fetch and show the weekly digest in chat
async function fetchAndShowDigest() {
  var el     = addAI('');
  var bubble = el.querySelector('.bubble');
  showWhisper('Preparing weekly digest...');
  try {
    var r = await fetch('/api/learn?action=digest', {
      headers: { 'X-Agent-Token': getSessionToken() }
    });
    var data = await r.json();
    hideWhisper();
    var dateLabel = get('weeklyDigestDate', '') || new Date().toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'short' });
    if (data.digest) {
      bubble.innerHTML = '<div style="font-size:11px;color:var(--text3);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.08em;">&#x1F4C6; Weekly digest â€” ' + dateLabel + '</div>' + fmt(data.digest);
    } else {
      bubble.innerHTML = 'Not enough interaction data yet for a weekly digest. Come back after a few more sessions.';
    }
  } catch(e) {
    hideWhisper();
    bubble.innerHTML = 'Could not retrieve digest right now.';
  }
  scrollBot();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var totalTokensUsed = 0;

// â”€â”€ WHISPER helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showWhisper(text) {
  var w = document.getElementById('whisper');
  if (w) { w.textContent = text; w.classList.add('show'); }
}
function hideWhisper() {
  var w = document.getElementById('whisper');
  if (w) { w.classList.remove('show'); w.textContent = ''; }
}

// â”€â”€ STREAMING callAI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns the full accumulated text when the stream ends.
// Calls onChunk(text) with each incremental piece so the UI can render live.
async function callAI(userMsg, onChunk) {
  var provider = get('brain', 'gemini');
  var history  = getCompactHistory();
  if (isGeminiLimited()) { var e = new Error('quota'); e.isQuota = true; throw e; }

  var sys = sysPrompt();
  var est = estimateTokens(sys) + estimateTokens(userMsg)
    + history.reduce(function(t, m) { return t + estimateTokens(m.content); }, 0);
  totalTokensUsed += est;
  console.log('[tokens] est input:', est, '| session total:', totalTokensUsed);

  var r = await fetch('/api/ai', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json', 'X-Agent-Token': getSessionToken() },
    body:    JSON.stringify({ provider: provider, systemPrompt: sys, history: history, userMessage: userMsg }),
  });

  if (!r.ok) {
    // Non-streaming error response
    var errText = await r.text();
    var errData;
    try { errData = errText ? JSON.parse(errText) : {}; } catch(e) { errData = {}; }
    var msg = errData.error || 'HTTP ' + r.status;
    var err = new Error(msg);
    if (r.status === 401) { handleSessionExpiry(); err.friendlyHTML = '<strong>Session expired.</strong> Please log in again.'; throw err; }
    err.friendlyHTML = '<strong>Error:</strong> ' + esc(msg);
    throw err;
  }

  // Read the SSE stream
  var reader  = r.body.getReader();
  var decoder = new TextDecoder();
  var buffer  = '';
  var full    = '';

  while (true) {
    var result = await reader.read();
    if (result.done) break;
    buffer += decoder.decode(result.value, { stream: true });

    var lines = buffer.split('\n');
    buffer = lines.pop(); // keep incomplete line

    for (var i = 0; i < lines.length; i++) {
      var line = lines[i];
      if (!line.startsWith('data: ')) continue;
      var raw = line.slice(6).trim();
      if (!raw || raw === '[DONE]') continue;
      try {
        var chunk = JSON.parse(raw);
        if (chunk.error) {
          var cerr = new Error(chunk.error);
          if (chunk.error.startsWith('QUOTA:') || chunk.error.toLowerCase().includes('quota')) {
            cerr.isQuota = true;
          }
          if (chunk.error.toLowerCase().includes('session') || chunk.error.toLowerCase().includes('unauthorized')) {
            handleSessionExpiry();
          }
          throw cerr;
        }
        if (chunk.t) {
          full += chunk.t;
          if (onChunk) onChunk(chunk.t);
        }
      } catch(parseErr) {
        if (parseErr.isQuota !== undefined || parseErr.friendlyHTML) throw parseErr;
        // skip malformed chunk
      }
    }
  }

  if (!full) throw new Error('Empty response from server.');
  return full;
}

async function githubAPI(payload) {
  var r = await fetch('/api/github', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json', 'X-Agent-Token': getSessionToken() },
    body:    JSON.stringify(payload),
  });
  var text = await r.text();
  var data;
  try { data = text ? JSON.parse(text) : {}; }
  catch(e) { throw new Error('GitHub API invalid response: ' + text.slice(0, 120)); }
  if (r.status === 401) { handleSessionExpiry(); throw new Error('Session expired â€” please log in again.'); }
  if (!r.ok) throw new Error(data.error || 'GitHub HTTP ' + r.status);
  return data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GITHUB â€” auto-detect repo + cached prefetch
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var REPO_RE   = /repo|repositor|github|my projects?|my sites?|what.*(have|own)|how many/i;
var COMMIT_RE = /commit|commit history|recent changes|what changed|last (push|update)/i;
var FILE_RE   = /(?:read|show|open|view|get|fetch)\s.{1,60}\.(html|css|js|md|json|txt|py)/i;
var _ghCache  = {};
var _repoList = null; // cached full repo list for the session

async function cachedGithubAPI(payload) {
  var key = JSON.stringify(payload);
  if (_ghCache[key]) return _ghCache[key];
  var result = await githubAPI(payload);
  _ghCache[key] = result;
  return result;
}

// â”€â”€ Fetch + cache all repos once per session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function ensureRepoList() {
  if (_repoList) return _repoList;
  var data = await cachedGithubAPI({ action: 'listRepos' });
  _repoList = data.repos || [];
  return _repoList;
}

// â”€â”€ Score how well a repo name matches what the user said â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns 0â€“100. Higher = better match.
function scoreRepoMatch(repoFullName, text) {
  var name  = repoFullName.split('/')[1] || repoFullName; // drop owner prefix
  var lname = name.toLowerCase();
  var ltext = text.toLowerCase();
  var score = 0;

  // Exact repo name mentioned
  if (ltext.includes(lname)) return 100;

  // Partial word matches â€” split repo name on hyphens/underscores
  var parts = lname.split(/[-_]/);
  parts.forEach(function(part) {
    if (part.length > 2 && ltext.includes(part)) score += 30;
  });

  // Keyword hints in the user message
  var hints = {
    'agent':   ['agent', 'ai', 'bot', 'assistant', 'claude'],
    'website': ['website', 'site', 'web', 'eritage', 'ent', 'clinic', 'eritageentcare'],
    'api':     ['api', 'backend', 'server', 'endpoint'],
    'app':     ['app', 'application', 'mobile', 'flutter'],
  };
  Object.keys(hints).forEach(function(repoHint) {
    if (lname.includes(repoHint)) {
      hints[repoHint].forEach(function(word) {
        if (ltext.includes(word)) score += 25;
      });
    }
  });

  return Math.min(score, 99); // 100 reserved for exact match
}

// â”€â”€ Auto-detect which repo the user is talking about â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns the matched repo full name, or null if no strong match.
// If a match is found and it differs from the current active repo, updates it
// and returns a notice string to inject into context.
async function autoDetectRepo(text) {
  // Only attempt detection when the message is code-related
  var codeSignals = /\b(repo|github|commit|deploy|push|file|code|fix|build|branch|project)\b/i;
  if (!codeSignals.test(text)) return null;

  showWhisper('Identifying repo...');
  var repos = await ensureRepoList();
  if (!repos.length) return null;

  // Score every repo against the user's message
  var scored = repos.map(function(r) {
    return { repo: r, score: scoreRepoMatch(r.name, text) };
  }).filter(function(s) { return s.score > 0; })
    .sort(function(a, b) { return b.score - a.score; });

  if (!scored.length) return null;

  var best      = scored[0];
  var threshold = 25; // minimum confidence to auto-switch

  if (best.score < threshold) return null;

  var currentRepo = get('repo1', '');
  var detectedRepo = best.repo.name; // full owner/repo

  if (detectedRepo === currentRepo) return null; // already set â€” no change needed

  // Switch active repo
  var shortName = detectedRepo.split('/')[1] || detectedRepo;
  set('repo1',     detectedRepo);
  set('repo1name', shortName);
  updateStatus();

  // Clear file/commit cache entries for old repo so fresh data is fetched
  Object.keys(_ghCache).forEach(function(k) {
    if (k.includes(currentRepo)) delete _ghCache[k];
  });

  // Show a small non-intrusive notice in the chat
  var noticeEl = document.createElement('div');
  noticeEl.style.cssText = 'width:100%;max-width:760px;margin:0 auto;padding:4px 24px 4px 72px;font-size:11.5px;color:var(--text3);';
  noticeEl.innerHTML = '&#x1F4C2; Switched to <strong style="color:var(--text2)">' + esc(detectedRepo) + '</strong>';
  document.getElementById('messages').appendChild(noticeEl);
  scrollBot();

  // Return a context note for the AI
  return 'ACTIVE REPO: ' + detectedRepo + ' (auto-detected).';
}

// â”€â”€ Main prefetch â€” auto-detect + context injection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function prefetchGitHub(text) {
  try {
    // Listing all repos
    if (REPO_RE.test(text)) {
      showWhisper('Checking your repos...');
      var repos = await ensureRepoList();
      if (!repos.length) return 'REPOS: none found.';
      var summary = repos.map(function(r) {
        var active = r.name === get('repo1', '') ? ' [ACTIVE]' : '';
        return r.name + (r.language ? ' [' + r.language + ']' : '') + active;
      }).join(', ');
      return 'REPOS (' + repos.length + '): ' + summary;
    }

    // Auto-detect repo before commit/file operations
    var switchNotice = await autoDetectRepo(text);

    if (COMMIT_RE.test(text)) {
      var repo = get('repo1', '');
      if (!repo) return switchNotice || 'No active repo set. Ask me to list your repos first.';
      showWhisper('Reading commit history...');
      var data2 = await cachedGithubAPI({ action: 'listCommits', repo: repo, limit: 5 });
      if (!data2.commits || !data2.commits.length) return switchNotice || null;
      var commitSummary = 'COMMITS ' + repo + ': ' + data2.commits.map(function(c) {
        return '[' + c.sha + '] ' + (c.date ? c.date.slice(0, 10) : '') + ': ' + c.message.slice(0, 60);
      }).join(' | ');
      return switchNotice ? switchNotice + ' ' + commitSummary : commitSummary;
    }

    if (FILE_RE.test(text)) {
      showWhisper('Fetching file...');
      var fileMatch = text.match(/[\w\-./]+\.(html|css|js|md|json|txt|py)/i);
      var repo2 = get('repo1', '');
      if (fileMatch && repo2) {
        var data3 = await cachedGithubAPI({ action: 'getFile', repo: repo2, path: fileMatch[0] });
        if (data3.content) {
          var capped = data3.content.length > 3000
            ? data3.content.slice(0, 3000) + '...[truncated]'
            : data3.content;
          var fileResult = 'FILE ' + fileMatch[0] + ':\n' + capped;
          return switchNotice ? switchNotice + '\n' + fileResult : fileResult;
        }
      }
      return switchNotice || null;
    }

    // Code-related message but no specific pattern â€” still return switch notice if any
    return switchNotice || null;

  } catch(e) {
    return 'GitHub prefetch failed: ' + e.message;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEPLOY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function executeDeploy(action, msgEl) {
  var repo   = action.repo, branch = action.branch, commit_message = action.commit_message, files = action.files;
  var bubble = msgEl.querySelector('.bubble');
  var log    = '';
  function appendLog(line, cls) {
    log += '<div class="' + (cls || '') + '">' + line + '</div>';
    bubble.querySelector('.deploy-log').innerHTML = log;
    scrollBot();
  }
  bubble.innerHTML = '<strong>Deploying...</strong>'
    + '<div class="deploy-bar-wrap"><div class="deploy-bar" id="dBar"></div></div>'
    + '<div class="deploy-label" id="dLabel">Starting...</div>'
    + '<div class="deploy-log"></div>';
  for (var i = 0; i < files.length; i++) {
    var f = files[i];
    document.getElementById('dBar').style.width = Math.round((i / files.length) * 100) + '%';
    document.getElementById('dLabel').textContent = i + '/' + files.length + ' â€” ' + f.path;
    appendLog('> ' + f.path, 'info');
    try {
      await githubAPI({ action: 'pushFile', repo: repo, branch: branch || 'main', path: f.path, content: f.content, commitMessage: commit_message || 'update: ' + f.path });
      appendLog('  pushed', 'ok');
    } catch(e) { appendLog('  ERROR: ' + e.message, 'err'); }
    await new Promise(function(r) { setTimeout(r, 280); });
  }
  document.getElementById('dBar').style.width = '100%';
  document.getElementById('dLabel').textContent = files.length + '/' + files.length + ' complete';
  appendLog('Done! Vercel rebuilds in ~60s.', 'ok');
  scrollBot();
}

async function confirmDeploy(btn, actionStr) {
  btn.parentNode.innerHTML = '<em>Deploying...</em>';
  var action = JSON.parse(actionStr.replace(/&quot;/g, '"'));
  var el = addAI('<strong>Starting...</strong>');
  try { await executeDeploy(action, el); }
  catch(e) { el.querySelector('.bubble').innerHTML = 'Deploy failed: ' + esc(e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESPONSE HANDLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleResponse(raw, msgEl) {
  var memMatches = Array.from(raw.matchAll(/\[MEMORY\]([\s\S]*?)\[\/MEMORY\]/g));
  var ghMatch    = raw.match(/\[ACTION:GITHUB\]([\s\S]*?)\[\/ACTION:GITHUB\]/);
  var depMatch   = raw.match(/\[ACTION:DEPLOY\]([\s\S]*?)\[\/ACTION:DEPLOY\]/);

  // Save memory facts
  memMatches.forEach(function(m) {
    var fact  = m[1].trim();
    var facts = get('learnedFacts', []);
    if (!facts.includes(fact)) { facts.push(fact); set('learnedFacts', facts); }
  });

  // Detect mode switch announcements
  if (/switching to.*code mode|entering code mode/i.test(raw))      setMode('code');
  if (/switching to.*strategic mode|back to strategic/i.test(raw))  setMode('strategic');

  var display = raw
    .replace(/\[MEMORY\][\s\S]*?\[\/MEMORY\]/g, '')
    .replace(/\[ACTION:GITHUB\][\s\S]*?\[\/ACTION:GITHUB\]/g, '')
    .replace(/\[ACTION:DEPLOY\][\s\S]*?\[\/ACTION:DEPLOY\]/g, '')
    .trim();

  if (display) msgEl.querySelector('.bubble').innerHTML = fmt(display);
  scrollBot();

  // Handle GitHub action
  if (ghMatch) {
    var ghPayload;
    try { ghPayload = safeParseJSON(ghMatch[1]); }
    catch(e) { addAI('GitHub action JSON malformed. Rephrase your request.'); return; }
    showWhisper('Calling GitHub API...');
    var fetchEl = addAI('');
    var ghResult;
    try {
      ghResult = await githubAPI(ghPayload);
      fetchEl.querySelector('.bubble').innerHTML = '<em>Got data â€” summarising...</em>';
    } catch(e) { fetchEl.querySelector('.bubble').innerHTML = 'GitHub error: ' + esc(e.message); return; }
    var followUp = 'Live GitHub data for ' + ghPayload.action + ':\n\n' + JSON.stringify(ghResult, null, 2) + '\n\nSummarise this clearly in plain language.';
    pushConvo('assistant', raw); pushConvo('user', followUp);
    showWhisper('Summarising data...');
    try {
      var fetchBubble = fetchEl.querySelector('.bubble');
      var followBuf = '';
      var followCursor = document.createElement('span');
      followCursor.className = 'cursor';
      fetchBubble.appendChild(followCursor);
      var summary = await callAI(followUp, function(chunk) {
        followBuf += chunk;
        hideWhisper();
        fetchBubble.innerHTML = fmt(followBuf);
        fetchBubble.appendChild(followCursor);
        scrollBot();
      });
      hideWhisper();
      var clean = summary.replace(/\[ACTION:GITHUB\][\s\S]*?\[\/ACTION:GITHUB\]/g, '').replace(/\[MEMORY\][\s\S]*?\[\/MEMORY\]/g, '').trim();
      fetchBubble.innerHTML = fmt(clean);
      pushConvo('assistant', summary);
    } catch(e) { hideWhisper(); fetchEl.querySelector('.bubble').innerHTML = e.friendlyHTML || ('Error: ' + esc(e.message)); }
    scrollBot(); return;
  }

  // Handle deploy action
  if (depMatch) {
    var action;
    try { action = safeParseJSON(depMatch[1]); }
    catch(e) { addAI('Deploy action had malformed JSON. Please try again.'); return; }
    var cnt  = (action.files && action.files.length) || 0;
    var safe = JSON.stringify(action).replace(/"/g, '&quot;');
    addAI('<strong>Ready to deploy ' + cnt + ' file(s) to <code>' + action.repo + '</code></strong><br/><br/>'
      + '<button class="action-btn green" onclick="confirmDeploy(this,\'' + safe + '\')">Yes, deploy</button>'
      + '<button class="action-btn red" onclick="this.closest(\'.msg-wrap\').remove()">Cancel</button>');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN SEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessageText(text) {
  scoreImplicitFeedback(text);
  detectMode(text);
  addUser(text);

  document.getElementById('statusDot').className    = 'status-dot thinking';
  document.getElementById('statusText').textContent = currentMode === 'code' ? 'Code Mode â€” thinking...' : 'Thinking...';

  try {
    // Reasoning gate â€” skip LLM for trivial inputs
    var deterministicReply = reasoningGate(text);
    if (deterministicReply) {
      if (deterministicReply !== '__ASYNC__') {
        // Sync reply â€” show directly
        addAI(deterministicReply);
        pushConvo('user', text);
        pushConvo('assistant', deterministicReply);
        if (!getCurrentSessionId()) set('currentSession', 'chat_' + Date.now());
        saveCurrentMessages();
      }
      // __ASYNC__ means an async handler is already running (profile summary / digest)
      return;
    }

    // Whisper: show what we're doing before LLM starts
    showWhisper(currentMode === 'code' ? 'Reading context...' : 'Thinking...');

    // Prefetch GitHub context if relevant
    var ghContext = await prefetchGitHub(text);
    var msgToSend = ghContext ? text + ' [GitHub: ' + ghContext + ']' : text;

    pushConvo('user', text);

    // Create empty AI message bubble â€” will be filled by stream
    var el     = addAI('');
    var bubble = el.querySelector('.bubble');
    var rawBuf = '';      // raw text accumulator
    var cursor = document.createElement('span');
    cursor.className = 'cursor';
    bubble.appendChild(cursor);

    showWhisper(currentMode === 'code' ? 'Writing code...' : 'Writing response...');

    // Stream â€” each chunk appended and rendered live
    var response = await callAI(msgToSend, function(chunk) {
      rawBuf += chunk;
      hideWhisper();
      // Render incrementally â€” update innerHTML with cursor at end
      bubble.innerHTML = fmt(rawBuf);
      bubble.appendChild(cursor);
      scrollBot();
    });

    // Final render â€” remove cursor, run full response handler
    bubble.innerHTML = '';
    hideWhisper();
    await handleResponse(response, el);

    pushConvo('assistant', response);
    _pendingFeedback = { userMsg: text, aiReply: response };

    if (!getCurrentSessionId()) set('currentSession', 'chat_' + Date.now());
    saveCurrentMessages();

  } catch(e) {
    hideWhisper();
    hideTyping();
    if (e.isQuota) { markGeminiLimited(); queueMessage(text); }
    else { addAI(e.friendlyHTML || ('<strong>Error:</strong> ' + esc(e.message))); }
  }
}

async function sendMessage() {
  var inp  = document.getElementById('userInput');
  var text = inp.value.trim();
  if (!text) return;
  var btn = document.getElementById('sendBtn');
  btn.disabled = true;
  inp.value = ''; inp.style.height = 'auto';
  try { await sendMessageText(text); }
  finally { btn.disabled = false; updateStatus(); inp.focus(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initApp() {
  if (!getCurrentSessionId()) set('currentSession', 'chat_' + Date.now());
  setMode(get('mode', 'strategic'));
  updateStatus();
  renderChatList();
  var id = getCurrentSessionId();
  if (id) {
    var session = loadSession(id);
    if (session && session.messages && session.messages.length) {
      set('conversation', session.messages);
      renderMessages(session.messages);
    } else {
      showWelcome();
    }
  } else {
    showWelcome();
  }
  if (!get('setupDone')) setTimeout(openSettings, 700);
  if (isGeminiLimited()) startCountdown();

  // Load adaptive profile from KV (non-blocking)
  fetchAdaptiveProfile().then(function(profile) {
    if (profile) console.log('[learn] profile loaded. Interactions:', profile.totalInteractions || 0);
  });

  // Run daily analysis if needed (non-blocking)
  maybeRunDailyAnalysis();

  document.getElementById('userInput').focus();
}

window.onload = function() {
  if (isLoggedIn()) {
    hideLoginScreen();
    initApp();
  } else {
    showLoginScreen();
  }
};
</script>
</body>
</html>
